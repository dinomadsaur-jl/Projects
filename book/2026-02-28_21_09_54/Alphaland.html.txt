l<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AlphaLand">
<meta name="theme-color" content="#FF6B35">

<!-- Apple touch icon (inline SVG â†’ data URI) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='38' fill='%23FF6B35'/%3E%3Ctext x='96' y='140' font-size='110' text-anchor='middle'%3E%F0%9F%A6%81%3C/text%3E%3C/svg%3E">

<title>AlphaLand ğŸ¦</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#FFF8F0; --primary:#FF6B35; --teal:#4ECDC4; --yellow:#FFE66D;
  --purple:#A855F7; --green:#22C55E; --pink:#F472B6; --dark:#2D2D2D;
  --shadow:0 8px 32px rgba(0,0,0,.12);
  --spring:cubic-bezier(0.34,1.56,0.64,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Nunito',sans-serif;background:var(--bg);touch-action:manipulation}

body::before{content:'';position:fixed;inset:0;pointer-events:none;
  background:radial-gradient(circle at 15% 15%,rgba(255,107,53,.07) 0%,transparent 50%),
             radial-gradient(circle at 85% 85%,rgba(78,205,196,.07) 0%,transparent 50%)}

/* â”€â”€ FLOATING LETTERS â”€â”€ */
#bg-letters{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.fl{position:absolute;font-family:'Fredoka One',cursive;opacity:.055;
    animation:drift linear infinite;color:var(--dark)}
@keyframes drift{from{transform:translateY(110vh) rotate(0deg)}to{transform:translateY(-10vh) rotate(360deg)}}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;position:fixed;inset:0;z-index:1;overflow-y:auto;overflow-x:hidden;
        animation:fadeUp .35s ease both;-webkit-overflow-scrolling:touch}
.screen.active{display:flex;flex-direction:column}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{display:flex;align-items:center;gap:.6rem;
        padding:clamp(.6rem,2.5vw,1rem) clamp(.6rem,2.5vw,1.2rem);
        background:#fff;box-shadow:0 2px 16px rgba(0,0,0,.07);
        position:sticky;top:0;z-index:50;flex-shrink:0}
.back-btn{background:var(--bg);border:none;width:44px;height:44px;border-radius:50%;
          font-size:1.3rem;cursor:pointer;display:flex;align-items:center;justify-content:center;
          transition:transform .15s var(--spring);flex-shrink:0}
.back-btn:active{transform:scale(.86)}
.topbar-title{font-family:'Fredoka One',cursive;font-size:clamp(1.1rem,4.5vw,1.5rem);
              color:var(--dark);flex:1}
.star-pill{font-size:clamp(.8rem,3vw,1rem);font-weight:800;color:var(--primary);
           background:#FFF3E0;padding:.25rem .75rem;border-radius:20px;white-space:nowrap}

/* â•â• HOME â•â• */
#home{align-items:center;justify-content:center;gap:clamp(1rem,4vw,2rem);padding:1.5rem}
.logo-wrap{text-align:center;animation:popIn .6s var(--spring)}
@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.logo-emoji{font-size:clamp(3.5rem,14vw,7rem);display:block;
            animation:floatAnim 3s ease-in-out infinite;line-height:1}
@keyframes floatAnim{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-10px) rotate(3deg)}}
.logo-title{font-family:'Fredoka One',cursive;font-size:clamp(2.2rem,9vw,4.5rem);
            background:linear-gradient(135deg,var(--primary),var(--purple));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
.logo-sub{font-size:clamp(.85rem,3.5vw,1.15rem);color:#999;font-weight:700;margin-top:.2rem}
.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(.6rem,2.5vw,.9rem);
           width:100%;max-width:420px}
.mode-btn{background:#fff;border:none;border-radius:22px;
          padding:clamp(.9rem,3.5vw,1.3rem);cursor:pointer;box-shadow:var(--shadow);
          display:flex;flex-direction:column;align-items:center;gap:.4rem;
          transition:transform .15s var(--spring)}
.mode-btn:active{transform:scale(.9)}
.mode-icon{font-size:clamp(1.8rem,7vw,2.6rem)}
.mode-label{font-family:'Fredoka One',cursive;font-size:clamp(.9rem,3.5vw,1.2rem);color:var(--dark)}

/* install banner */
#install-banner{display:none;align-items:center;justify-content:space-between;
                background:linear-gradient(135deg,var(--primary),var(--purple));
                color:#fff;padding:.75rem 1rem;border-radius:16px;gap:.75rem;
                width:100%;max-width:420px;cursor:pointer;box-shadow:var(--shadow);
                animation:popIn .5s var(--spring)}
#install-banner span{font-family:'Fredoka One',cursive;font-size:clamp(.9rem,3.5vw,1.1rem)}
#install-banner button{background:rgba(255,255,255,.25);border:none;border-radius:10px;
                        color:#fff;font-family:'Fredoka One',cursive;font-size:.9rem;
                        padding:.35rem .8rem;cursor:pointer;white-space:nowrap}
#install-banner .ib-close{background:transparent;font-size:1.1rem;padding:.2rem .4rem}

@media(orientation:landscape) and (max-height:520px){
  #home{flex-direction:row;justify-content:space-evenly;padding:.6rem 1.2rem}
  .mode-grid{grid-template-columns:repeat(4,1fr);max-width:none;flex:1}
  .logo-emoji{font-size:clamp(2.5rem,8vw,4rem)}
}

/* â•â• LEARN â•â• */
.scroll-area{flex:1;overflow-y:auto;padding:clamp(.6rem,2.5vw,1rem);-webkit-overflow-scrolling:touch}
.alpha-grid{display:grid;
            grid-template-columns:repeat(auto-fill,minmax(clamp(64px,17vw,105px),1fr));
            gap:clamp(.4rem,1.8vw,.75rem)}
.alpha-card{aspect-ratio:1;border-radius:18px;background:#fff;border:none;cursor:pointer;
            box-shadow:0 4px 14px rgba(0,0,0,.09);display:flex;flex-direction:column;
            align-items:center;justify-content:center;gap:.1rem;
            transition:transform .15s var(--spring);position:relative;overflow:hidden}
.alpha-card:active{transform:scale(.87)}
.alpha-card.done::after{content:'â­';position:absolute;top:3px;right:4px;font-size:.65rem}
.a-letter{font-family:'Fredoka One',cursive;font-size:clamp(1.6rem,6.5vw,2.7rem);line-height:1}
.a-word{font-size:clamp(.5rem,1.8vw,.72rem);font-weight:700;color:#AAA;text-transform:uppercase;letter-spacing:.05em}

/* â•â• DETAIL â•â• */
#detail{flex-direction:column}
.detail-hero{flex:1;display:flex;flex-direction:column;align-items:center;
             justify-content:center;padding:clamp(.6rem,2.5vw,1.2rem);
             gap:clamp(.6rem,2.5vw,1rem);text-align:center;min-height:0}
.big-letter{font-family:'Fredoka One',cursive;font-size:clamp(5rem,22vw,11rem);
            line-height:1;cursor:pointer;user-select:none;display:block;
            animation:letterPop .5s var(--spring)}
.big-letter:active{transform:scale(.87) rotate(-8deg)}
@keyframes letterPop{from{transform:scale(0) rotate(-20deg)}60%{transform:scale(1.15) rotate(5deg)}to{transform:scale(1) rotate(0)}}
.letter-cases{font-family:'Fredoka One',cursive;font-size:clamp(1.3rem,5vw,2.2rem);color:#CCC}
.d-emoji{font-size:clamp(2.8rem,11vw,5.5rem);animation:emojiFloat 2s ease-in-out infinite;cursor:pointer}
@keyframes emojiFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-7px) scale(1.06)}}
.d-word{font-family:'Fredoka One',cursive;font-size:clamp(1.6rem,6.5vw,3rem);color:var(--dark)}
.d-word .hl{text-decoration:underline;text-underline-offset:4px}
.hear-btn{background:linear-gradient(135deg,var(--primary),var(--purple));border:none;
          border-radius:18px;padding:clamp(.6rem,2.5vw,.9rem) clamp(1.2rem,5vw,2.2rem);
          color:#fff;font-family:'Fredoka One',cursive;font-size:clamp(.95rem,3.8vw,1.3rem);
          cursor:pointer;box-shadow:0 6px 18px rgba(255,107,53,.32);
          transition:transform .15s var(--spring);display:flex;align-items:center;gap:.4rem}
.hear-btn:active{transform:scale(.91)}
.detail-nav{display:flex;align-items:center;justify-content:space-between;
            padding:clamp(.6rem,2.5vw,1rem);gap:.6rem;flex-shrink:0}
.nav-arr{background:#fff;border:none;border-radius:14px;
         padding:.6rem 1.1rem;font-size:1.4rem;cursor:pointer;
         box-shadow:0 4px 12px rgba(0,0,0,.09);transition:transform .15s var(--spring)}
.nav-arr:active{transform:scale(.87)}
.nav-arr:disabled{opacity:.28;pointer-events:none}
.d-counter{font-family:'Fredoka One',cursive;font-size:1rem;color:#BBB}
@media(orientation:landscape) and (max-height:520px){
  .detail-hero{flex-direction:row;text-align:left;padding:.5rem 1.2rem;gap:1.2rem}
}

/* â•â• SPELL â•â• */
#spell{flex-direction:column}
.spell-body{flex:1;display:flex;flex-direction:column;align-items:center;
            justify-content:center;padding:clamp(.6rem,2.5vw,1.2rem);
            gap:clamp(.6rem,2.5vw,1rem);min-height:0}
.sp-emoji{font-size:clamp(3.5rem,15vw,7rem);display:block;cursor:pointer;
          animation:emojiFloat 2.2s ease-in-out infinite}
.sp-hint{font-family:'Fredoka One',cursive;font-size:clamp(1.3rem,5vw,2rem);
         color:#D0D0D0;letter-spacing:.35em;margin-top:.2rem}
.sp-slots{display:flex;justify-content:center;gap:clamp(.25rem,1.3vw,.55rem);flex-wrap:wrap}
.slot{width:clamp(38px,9.5vw,60px);height:clamp(46px,11.5vw,72px);
      border-radius:13px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);
      display:flex;align-items:center;justify-content:center;
      font-family:'Fredoka One',cursive;font-size:clamp(1.3rem,4.5vw,2rem);
      transition:all .2s var(--spring);border:3px solid transparent}
.slot.filled{border-color:var(--teal);background:#E0FAF8}
.slot.correct{border-color:var(--green);background:#DCFCE7;animation:slotPop .3s var(--spring)}
.slot.wrong{border-color:var(--primary);background:#FEE2E2;animation:shake .4s}
@keyframes slotPop{0%{transform:scale(1)}50%{transform:scale(1.28)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.sp-choices{display:flex;justify-content:center;gap:clamp(.25rem,1.3vw,.55rem);flex-wrap:wrap}
.choice-btn{width:clamp(42px,10.5vw,64px);height:clamp(42px,10.5vw,64px);
            border-radius:13px;background:#fff;border:none;cursor:pointer;
            font-family:'Fredoka One',cursive;font-size:clamp(1.3rem,4.5vw,1.9rem);
            box-shadow:0 4px 14px rgba(0,0,0,.11);
            transition:transform .15s var(--spring),opacity .2s;
            display:flex;align-items:center;justify-content:center;color:var(--dark)}
.choice-btn:active{transform:scale(.86)}
.choice-btn.used{opacity:.18;pointer-events:none}
.feedback{font-family:'Fredoka One',cursive;font-size:clamp(1.1rem,4.5vw,1.6rem);
          text-align:center;min-height:1.8rem;transition:all .25s}
.feedback.ok{color:var(--green);animation:feedPop .35s var(--spring)}
.feedback.no{color:var(--primary)}
@keyframes feedPop{from{transform:scale(.5)}to{transform:scale(1)}}
.prog-bar{height:7px;background:#EEE;border-radius:4px;overflow:hidden;width:100%;max-width:400px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--purple));
           border-radius:4px;transition:width .5s ease}
@media(orientation:landscape) and (max-height:520px){
  .spell-body{flex-direction:row;flex-wrap:wrap;justify-content:space-around;align-items:center}
}

/* â•â• QUIZ â•â• */
#quiz{flex-direction:column}
.quiz-body{flex:1;display:flex;flex-direction:column;align-items:center;
           justify-content:center;padding:clamp(.6rem,2.5vw,1.2rem);
           gap:clamp(.8rem,3vw,1.3rem);text-align:center;min-height:0}
.quiz-q{font-family:'Fredoka One',cursive;font-size:clamp(1.1rem,4.5vw,1.8rem);color:var(--dark)}
.quiz-emoji{font-size:clamp(3.5rem,16vw,7.5rem);cursor:pointer;animation:emojiFloat 2.5s ease-in-out infinite}
.quiz-grid{display:grid;grid-template-columns:1fr 1fr;gap:clamp(.5rem,2vw,.85rem);
           width:100%;max-width:380px}
.quiz-btn{background:#fff;border:none;border-radius:18px;
          padding:clamp(.6rem,2.5vw,1.1rem);font-family:'Fredoka One',cursive;
          font-size:clamp(1.7rem,6.5vw,2.8rem);cursor:pointer;
          box-shadow:0 4px 14px rgba(0,0,0,.1);transition:transform .15s var(--spring)}
.quiz-btn:active{transform:scale(.88)}
.quiz-btn.correct{background:#DCFCE7;box-shadow:0 4px 14px rgba(34,197,94,.3)}
.quiz-btn.wrong{background:#FEE2E2;box-shadow:0 4px 14px rgba(255,107,53,.3);animation:shake .4s}

/* â•â• PROGRESS â•â• */
#progress{flex-direction:column}
.prog-msg{text-align:center;padding:.75rem 1rem;font-family:'Fredoka One',cursive;
          font-size:clamp(1rem,4vw,1.4rem);color:#AAA}

/* â•â• CONFETTI â•â• */
#confetti{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden}
.cp{position:absolute;top:-14px;border-radius:2px;animation:fall linear forwards}
@keyframes fall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* â•â• TOAST â•â• */
#toast{position:fixed;top:1rem;left:50%;
       transform:translateX(-50%) translateY(-120px);
       background:var(--dark);color:#fff;padding:.6rem 1.4rem;border-radius:20px;
       font-weight:700;font-size:.85rem;z-index:9999;
       transition:transform .4s var(--spring);white-space:nowrap;max-width:90vw;text-align:center}
#toast.show{transform:translateX(-50%) translateY(0)}

/* â•â• PYODIDE STATUS â•â• */
#pystatus{position:fixed;bottom:.75rem;right:.75rem;background:#fff;border-radius:10px;
          padding:.35rem .8rem;font-size:.75rem;font-weight:700;color:#999;
          box-shadow:0 2px 10px rgba(0,0,0,.1);z-index:200;
          display:flex;align-items:center;gap:.35rem;transition:opacity .6s}
.pydot{width:7px;height:7px;border-radius:50%;background:#CCC;animation:pulse 1.5s infinite}
.pydot.ok{background:var(--green);animation:none}
.pydot.warn{background:#FFB347;animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:#DDD;border-radius:3px}
</style>
</head>
<body>

<div id="bg-letters"></div>
<div id="confetti"></div>
<div id="toast"></div>
<div id="pystatus"><div class="pydot" id="pydot"></div><span id="pytext">Loading Pythonâ€¦</span></div>

<!-- â•â• HOME â•â• -->
<div class="screen active" id="home">
  <div class="logo-wrap">
    <span class="logo-emoji">ğŸ¦</span>
    <div class="logo-title">AlphaLand</div>
    <div class="logo-sub">Learn letters &amp; words!</div>
  </div>
  <div class="mode-grid">
    <button class="mode-btn" onclick="goLearn()"><span class="mode-icon">ğŸ”¤</span><span class="mode-label">Alphabet</span></button>
    <button class="mode-btn" onclick="goSpell()"><span class="mode-icon">âœï¸</span><span class="mode-label">Spelling</span></button>
    <button class="mode-btn" onclick="goQuiz()"><span class="mode-icon">ğŸ¯</span><span class="mode-label">Quiz</span></button>
    <button class="mode-btn" onclick="goProgress()"><span class="mode-icon">â­</span><span class="mode-label">Progress</span></button>
  </div>
  <!-- Install Banner (shown when browser fires beforeinstallprompt) -->
  <div id="install-banner">
    <span>ğŸ“± Install AlphaLand!</span>
    <button onclick="doInstall()">Install</button>
    <button class="ib-close" onclick="hideBanner()">âœ•</button>
  </div>
</div>

<!-- â•â• LEARN â•â• -->
<div class="screen" id="learn">
  <div class="topbar">
    <button class="back-btn" onclick="goHome()">â†</button>
    <span class="topbar-title">ğŸ”¤ Alphabet</span>
    <div class="star-pill">â­ <span class="sc">0</span></div>
  </div>
  <div class="scroll-area"><div class="alpha-grid" id="alphaGrid"></div></div>
</div>

<!-- â•â• DETAIL â•â• -->
<div class="screen" id="detail">
  <div class="topbar">
    <button class="back-btn" onclick="goLearn()">â†</button>
    <span class="topbar-title" id="dTitle">Letter A</span>
    <div class="star-pill">â­ <span class="sc">0</span></div>
  </div>
  <div class="detail-hero">
    <div style="text-align:center">
      <span class="big-letter" id="bigL" onclick="spkLetter()">A</span>
      <div class="letter-cases" id="dCases">A &nbsp; a</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:.6rem;text-align:center">
      <span class="d-emoji" id="dEmoji" onclick="spkWord()">ğŸ</span>
      <div class="d-word" id="dWordEl"><span class="hl">A</span>pple</div>
      <button class="hear-btn" onclick="spkAll()">ğŸ”Š Hear it!</button>
    </div>
  </div>
  <div class="detail-nav">
    <button class="nav-arr" id="prevBtn" onclick="prevL()">â—€</button>
    <div class="d-counter" id="dCounter">1 / 26</div>
    <button class="nav-arr" id="nextBtn" onclick="nextL()">â–¶</button>
  </div>
</div>

<!-- â•â• SPELL â•â• -->
<div class="screen" id="spell">
  <div class="topbar">
    <button class="back-btn" onclick="goHome()">â†</button>
    <span class="topbar-title">âœï¸ Spell It!</span>
    <div class="star-pill">â­ <span class="sc">0</span></div>
  </div>
  <div class="spell-body">
    <div style="text-align:center">
      <span class="sp-emoji" id="spEmoji" onclick="spkSpell()">ğŸ±</span>
      <div class="sp-hint" id="spHint">_ _ _</div>
    </div>
    <div style="width:100%;max-width:440px;display:flex;flex-direction:column;align-items:center;gap:.55rem">
      <div class="sp-slots" id="spSlots"></div>
      <div class="sp-choices" id="spChoices"></div>
      <div class="feedback" id="spFeed"></div>
      <div class="prog-bar"><div class="prog-fill" id="spProg" style="width:0%"></div></div>
    </div>
  </div>
</div>

<!-- â•â• QUIZ â•â• -->
<div class="screen" id="quiz">
  <div class="topbar">
    <button class="back-btn" onclick="goHome()">â†</button>
    <span class="topbar-title">ğŸ¯ Letter Quiz</span>
    <div class="star-pill">â­ <span class="sc">0</span></div>
  </div>
  <div class="quiz-body">
    <div class="quiz-q" id="quizQ">Which letter starts this word?</div>
    <span class="quiz-emoji" id="quizEmoji" onclick="spkQuiz()">ğŸ</span>
    <div class="quiz-grid" id="quizGrid"></div>
    <div class="feedback" id="quizFeed"></div>
  </div>
</div>

<!-- â•â• PROGRESS â•â• -->
<div class="screen" id="progress">
  <div class="topbar">
    <button class="back-btn" onclick="goHome()">â†</button>
    <span class="topbar-title">â­ My Progress</span>
    <div class="star-pill">â­ <span class="sc">0</span></div>
  </div>
  <div class="scroll-area">
    <div class="prog-msg" id="progMsg"></div>
    <div class="alpha-grid" id="progGrid"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  1. MANIFEST  â€” injected as a blob so the browser sees it
//     as a real linked manifest (works on Android Chrome,
//     partially on iOS â€” see note below).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function injectManifest(){
  // Tiny SVG lion icon encoded as a data URI inside the manifest
  const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="%23FF6B35"/><text x="256" y="340" font-size="260" text-anchor="middle">ğŸ¦</text></svg>`;
  const icon192 = `data:image/svg+xml,${iconSvg}`;

  const manifest = {
    name: "AlphaLand - Kids Alphabet",
    short_name: "AlphaLand",
    description: "Fun alphabet & spelling app for kids aged 3-5",
    start_url: "./",           // relative so it works from any path
    display: "standalone",
    orientation: "any",
    background_color: "#FFF8F0",
    theme_color: "#FF6B35",
    lang: "en",
    categories: ["education","kids","games"],
    icons: [
      { src: icon192, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: icon192, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ],
    screenshots: [],
    prefer_related_applications: false
  };

  const blob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
  const url  = URL.createObjectURL(blob);
  const link = Object.assign(document.createElement("link"), { rel:"manifest", href: url });
  document.head.appendChild(link);

  // iOS note: Safari ignores blob-manifest for the install prompt.
  // The apple-mobile-web-app-* meta tags above handle iOS standalone mode.
  // Android Chrome fully respects the blob manifest â†’ shows install banner.
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  2. SERVICE WORKER  â€” registered from an inline blob.
//     Caches: app shell, Pyodide CDN, Google Fonts.
//     Strategy: Cache-first for CDN assets, Network-first
//     for the app shell (so updates land on next visit).
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function registerSW(){
  if (!('serviceWorker' in navigator)) return;

  const SW = `
const APP   = 'al-app-v2';
const PY    = 'al-pyodide-v2';
const FONTS = 'al-fonts-v2';
const ALL   = [APP, PY, FONTS];

// On install: pre-cache just the page itself
self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(APP)
      .then(c => c.add(self.location.href.replace(/\\/[^/]*$/, '/')))
      .catch(() => {}) // if root 404s, continue anyway
  );
  self.skipWaiting();
});

// On activate: delete old caches
self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys()
      .then(keys => Promise.all(
        keys.filter(k => !ALL.includes(k)).map(k => caches.delete(k))
      ))
  );
  self.clients.claim();
});

self.addEventListener('fetch', e => {
  const u = new URL(e.request.url);

  // â”€â”€ Pyodide / jsdelivr  â†’  Cache-first (large files, rarely change) â”€â”€
  if (u.hostname.includes('jsdelivr') || u.hostname.includes('pyodide')) {
    e.respondWith(
      caches.open(PY).then(async c => {
        const cached = await c.match(e.request);
        if (cached) return cached;
        try {
          const res = await fetch(e.request);
          if (res.ok) c.put(e.request, res.clone());
          return res;
        } catch { return cached || new Response('', { status: 503 }); }
      })
    );
    return;
  }

  // â”€â”€ Google Fonts  â†’  Cache-first â”€â”€
  if (u.hostname.includes('fonts.g') || u.hostname.includes('fonts.gstatic')) {
    e.respondWith(
      caches.open(FONTS).then(async c => {
        const cached = await c.match(e.request);
        if (cached) return cached;
        try {
          const res = await fetch(e.request);
          if (res.ok) c.put(e.request, res.clone());
          return res;
        } catch { return cached || new Response('', { status: 503 }); }
      })
    );
    return;
  }

  // â”€â”€ App shell  â†’  Network-first, fall back to cache â”€â”€
  e.respondWith(
    fetch(e.request)
      .then(res => {
        if (res.ok) {
          const clone = res.clone();
          caches.open(APP).then(c => c.put(e.request, clone));
        }
        return res;
      })
      .catch(() => caches.match(e.request))
  );
});
`;

  const blob = new Blob([SW], { type: 'application/javascript' });
  const url  = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url)
    .then(r => console.log('[SW] registered', r.scope))
    .catch(e => console.warn('[SW] failed', e));
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  3. DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AZ = [
  {l:'A',w:'Apple',     e:'ğŸ',c:'#FF6B6B'},
  {l:'B',w:'Butterfly', e:'ğŸ¦‹',c:'#FFB347'},
  {l:'C',w:'Cat',       e:'ğŸ±',c:'#FFD700'},
  {l:'D',w:'Dog',       e:'ğŸ¶',c:'#87CEEB'},
  {l:'E',w:'Elephant',  e:'ğŸ˜',c:'#DDA0DD'},
  {l:'F',w:'Fish',      e:'ğŸŸ',c:'#87CEEB'},
  {l:'G',w:'Giraffe',   e:'ğŸ¦’',c:'#FFD700'},
  {l:'H',w:'House',     e:'ğŸ ',c:'#FF8C69'},
  {l:'I',w:'Ice Cream', e:'ğŸ¦',c:'#FFB6C1'},
  {l:'J',w:'Jellyfish', e:'ğŸª¼',c:'#E6E6FA'},
  {l:'K',w:'Kangaroo',  e:'ğŸ¦˜',c:'#DEB887'},
  {l:'L',w:'Lion',      e:'ğŸ¦',c:'#FFD700'},
  {l:'M',w:'Monkey',    e:'ğŸµ',c:'#DEB887'},
  {l:'N',w:'Narwhal',   e:'ğŸ¦„',c:'#6495ED'},
  {l:'O',w:'Orange',    e:'ğŸŠ',c:'#FF8C00'},
  {l:'P',w:'Penguin',   e:'ğŸ§',c:'#4169E1'},
  {l:'Q',w:'Queen',     e:'ğŸ‘‘',c:'#FFD700'},
  {l:'R',w:'Rainbow',   e:'ğŸŒˆ',c:'#FF69B4'},
  {l:'S',w:'Star',      e:'â­',c:'#FFD700'},
  {l:'T',w:'Tiger',     e:'ğŸ¯',c:'#FF8C00'},
  {l:'U',w:'Umbrella',  e:'â˜‚ï¸',c:'#6495ED'},
  {l:'V',w:'Violin',    e:'ğŸ»',c:'#8B4513'},
  {l:'W',w:'Whale',     e:'ğŸ³',c:'#4169E1'},
  {l:'X',w:'Xylophone', e:'ğŸµ',c:'#FF6B6B'},
  {l:'Y',w:'Yak',       e:'ğŸ‚',c:'#8B4513'},
  {l:'Z',w:'Zebra',     e:'ğŸ¦“',c:'#696969'},
];

const WORDS = [
  {w:'CAT',e:'ğŸ±'},{w:'DOG',e:'ğŸ¶'},{w:'SUN',e:'â˜€ï¸'},{w:'BUS',e:'ğŸšŒ'},
  {w:'CUP',e:'â˜•'},{w:'HEN',e:'ğŸ”'},{w:'PIG',e:'ğŸ·'},{w:'BAT',e:'ğŸ¦‡'},
  {w:'ANT',e:'ğŸœ'},{w:'BEE',e:'ğŸ'},{w:'COW',e:'ğŸ„'},{w:'FOX',e:'ğŸ¦Š'},
  {w:'JAM',e:'ğŸ«™'},{w:'NET',e:'ğŸ•¸ï¸'},{w:'POT',e:'ğŸ«•'},{w:'RAT',e:'ğŸ­'},
  {w:'FROG',e:'ğŸ¸'},{w:'DUCK',e:'ğŸ¦†'},{w:'CAKE',e:'ğŸ‚'},{w:'FISH',e:'ğŸŸ'},
  {w:'BEAR',e:'ğŸ»'},{w:'BIRD',e:'ğŸ¦'},{w:'BOAT',e:'â›µ'},{w:'BELL',e:'ğŸ””'},
  {w:'CRAB',e:'ğŸ¦€'},{w:'DEER',e:'ğŸ¦Œ'},{w:'GOAT',e:'ğŸ'},{w:'KITE',e:'ğŸª'},
  {w:'LEAF',e:'ğŸƒ'},{w:'MOON',e:'ğŸŒ™'},
];


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  4. PYODIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pyReady = false;
let pyodide  = null;

async function initPy() {
  try {
    pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });

    await pyodide.runPythonAsync(`
import json, random

class Game:
    # â”€â”€ Spelling: correct letters + distractor letters, shuffled â”€â”€
    def spell_choices(self, word):
        letters  = list(word)
        pool     = [c for c in 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' if c not in letters]
        extra    = random.sample(pool, min(4, len(pool)))
        result   = letters + extra
        random.shuffle(result)
        return json.dumps(result)

    # â”€â”€ Quiz: 3 wrong + 1 correct, shuffled â”€â”€
    def quiz_choices(self, answer, all_letters_json):
        all_letters = json.loads(all_letters_json)
        wrong  = [l for l in all_letters if l != answer]
        chosen = random.sample(wrong, min(3, len(wrong)))
        result = chosen + [answer]
        random.shuffle(result)
        return json.dumps(result)

    # â”€â”€ Motivational star message â”€â”€
    def star_msg(self, n):
        if   n == 0:  return "Let's start learning! ğŸŒŸ"
        elif n <  5:  return f"Great start! {n} stars! Keep going! ğŸš€"
        elif n < 15:  return f"You're amazing! {n} stars! â­"
        elif n < 30:  return f"Super smart! {n} stars! ğŸ§ "
        else:         return f"ALPHABET CHAMPION! {n} stars! ğŸ†"

game = Game()
print("âœ… AlphaLand Python backend ready")
`);

    pyReady = true;
    document.getElementById('pydot').classList.add('ok');
    document.getElementById('pytext').textContent = 'Python âœ“';
    setTimeout(() => document.getElementById('pystatus').style.opacity = '0', 3000);

  } catch (err) {
    console.warn('[Pyodide] failed, using JS fallback:', err);
    document.getElementById('pydot').classList.add('warn');
    document.getElementById('pytext').textContent = 'JS mode';
    setTimeout(() => document.getElementById('pystatus').style.opacity = '0', 4000);
  }
}

// â”€â”€ Wrappers with JS fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pySpellChoices(word) {
  if (pyReady) {
    const r = await pyodide.runPythonAsync(`game.spell_choices("${word}")`);
    return JSON.parse(r);
  }
  // JS fallback
  const letters = [...word];
  const pool    = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(c => !letters.includes(c));
  const extra   = pool.sort(() => Math.random() - .5).slice(0, 4);
  return [...letters, ...extra].sort(() => Math.random() - .5);
}

async function pyQuizChoices(answer) {
  const all = AZ.map(a => a.l);
  if (pyReady) {
    const r = await pyodide.runPythonAsync(
      `game.quiz_choices("${answer}", '${JSON.stringify(all)}')`
    );
    return JSON.parse(r);
  }
  // JS fallback
  const wrong = all.filter(l => l !== answer).sort(() => Math.random() - .5).slice(0, 3);
  return [...wrong, answer].sort(() => Math.random() - .5);
}

async function pyStarMsg(n) {
  if (pyReady) return await pyodide.runPythonAsync(`game.star_msg(${n})`);
  if (n === 0)  return "Let's start learning! ğŸŒŸ";
  if (n < 5)    return `Great start! ${n} stars! ğŸš€`;
  if (n < 15)   return `Amazing! ${n} stars! â­`;
  return `Champion! ${n} stars! ğŸ†`;
}

// Load Pyodide script dynamically
(function loadPyScript() {
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
  s.onload  = initPy;
  s.onerror = () => {
    document.getElementById('pytext').textContent = 'Offline JS mode';
    document.getElementById('pydot').classList.add('warn');
    setTimeout(() => document.getElementById('pystatus').style.opacity = '0', 4000);
  };
  document.head.appendChild(s);
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  5. APP STATE & UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stars   = +localStorage.getItem('al_stars')  || 0;
let learned = JSON.parse(localStorage.getItem('al_learned') || '{}');
let curIdx  = 0;
let sp = {};   // spell state
let qz = {};   // quiz state

const save = () => {
  localStorage.setItem('al_stars',   stars);
  localStorage.setItem('al_learned', JSON.stringify(learned));
};

const addStars = n => {
  stars += n;
  save();
  document.querySelectorAll('.sc').forEach(e => e.textContent = stars);
};

const rand = arr => arr[Math.floor(Math.random() * arr.length)];

const speak = (text, rate = 0.82) => {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate  = rate;
  u.pitch = 1.2;
  speechSynthesis.speak(u);
};

const showToast = (msg, ms = 3500) => {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), ms);
};

function confetti() {
  const cols = ['#FF6B35','#4ECDC4','#FFE66D','#A855F7','#22C55E','#F472B6'];
  const el   = document.getElementById('confetti');
  for (let i = 0; i < 55; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.className = 'cp';
      const size = 8 + Math.random() * 10;
      p.style.cssText = `
        left:${Math.random()*100}%;
        background:${rand(cols)};
        width:${size}px; height:${size}px;
        animation-duration:${1.4 + Math.random() * 1.4}s;
        animation-delay:${Math.random() * .4}s;
        border-radius:${Math.random() > .5 ? '50%' : '2px'};
        transform:rotate(${Math.random()*360}deg)`;
      el.appendChild(p);
      setTimeout(() => p.remove(), 3000);
    }, i * 28);
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  6. INSTALL BANNER
//     Android Chrome fires beforeinstallprompt when all
//     PWA criteria pass. We capture it and show our own UI.
//     iOS doesn't fire this event â€” users must use
//     Safari Share â†’ Add to Home Screen manually.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstall = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();               // stop browser's default mini-bar
  deferredInstall = e;
  document.getElementById('install-banner').style.display = 'flex';
});

window.addEventListener('appinstalled', () => {
  hideBanner();
  showToast('ğŸ‰ AlphaLand installed! Find it on your home screen.');
});

function doInstall() {
  if (!deferredInstall) return;
  deferredInstall.prompt();
  deferredInstall.userChoice.then(r => {
    if (r.outcome === 'accepted') hideBanner();
    deferredInstall = null;
  });
}

function hideBanner() {
  document.getElementById('install-banner').style.display = 'none';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  7. FLOATING BACKGROUND LETTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function buildBg() {
  const c = document.getElementById('bg-letters');
  'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(l => {
    const d = document.createElement('div');
    d.className = 'fl';
    d.textContent = l;
    d.style.cssText = `
      left:${Math.random()*95}%;
      font-size:${2 + Math.random()*3}rem;
      animation-duration:${15 + Math.random()*18}s;
      animation-delay:${-Math.random()*18}s`;
    c.appendChild(d);
  });
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  8. ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}
function goHome()     { show('home'); }
function goLearn()    { buildAlphaGrid(); show('learn'); }
function goProgress() { buildProgGrid(); show('progress'); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  9. LEARN â€” alphabet grid
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAlphaGrid() {
  const g = document.getElementById('alphaGrid');
  g.innerHTML = '';
  AZ.forEach((d, i) => {
    const b = document.createElement('button');
    b.className = 'alpha-card' + (learned[d.l] ? ' done' : '');
    b.style.background = `linear-gradient(135deg,${d.c}22,${d.c}44)`;
    b.innerHTML = `
      <span class="a-letter" style="color:${d.c}">${d.l}</span>
      <span class="a-word">${d.w}</span>`;
    b.onclick = () => { curIdx = i; openDetail(); };
    g.appendChild(b);
  });
  document.querySelectorAll('#learn .sc').forEach(e => e.textContent = stars);
}

function openDetail() {
  renderDetail();
  show('detail');
  setTimeout(() => speak(`${AZ[curIdx].l} is for ${AZ[curIdx].w}!`, .85), 280);
}

function renderDetail() {
  const d = AZ[curIdx];
  document.getElementById('dTitle').textContent   = `Letter ${d.l}`;
  document.getElementById('bigL').textContent     = d.l;
  document.getElementById('bigL').style.color     = d.c;
  document.getElementById('dCases').textContent   = `${d.l}   ${d.l.toLowerCase()}`;
  document.getElementById('dEmoji').textContent   = d.e;
  document.getElementById('dWordEl').innerHTML    =
    `<span class="hl" style="color:${d.c}">${d.l}</span>${d.w.slice(1)}`;
  document.getElementById('dCounter').textContent = `${curIdx + 1} / 26`;
  document.getElementById('prevBtn').disabled     = curIdx === 0;
  document.getElementById('nextBtn').disabled     = curIdx === 25;
  document.querySelectorAll('#detail .sc').forEach(e => e.textContent = stars);
}

function spkLetter() { speak(AZ[curIdx].l, .7); }
function spkWord()   { speak(AZ[curIdx].w); }
function spkAll() {
  const d = AZ[curIdx];
  speak(`${d.l} is for ${d.w}!`, .85);
  learned[d.l] = true; save(); addStars(1); confetti();
  buildAlphaGrid();   // refresh stars on cards
}

function prevL() {
  if (curIdx > 0) {
    curIdx--;
    renderDetail();
    setTimeout(() => speak(`${AZ[curIdx].l} is for ${AZ[curIdx].w}!`, .85), 220);
  }
}
function nextL() {
  if (curIdx < 25) {
    learned[AZ[curIdx].l] = true; save();
    curIdx++;
    renderDetail();
    setTimeout(() => speak(`${AZ[curIdx].l} is for ${AZ[curIdx].w}!`, .85), 220);
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  10. SPELL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function goSpell() {
  await nextSpellWord();
  show('spell');
}

async function nextSpellWord() {
  const wd      = rand(WORDS);
  const choices = await pySpellChoices(wd.w);
  sp = { wd, filled: Array(wd.w.length).fill(null), choices, used: Array(choices.length).fill(false) };

  document.getElementById('spEmoji').textContent = wd.e;
  document.getElementById('spHint').textContent  = wd.w.split('').map(() => '_').join(' ');
  document.getElementById('spFeed').textContent  = '';
  document.getElementById('spFeed').className    = 'feedback';

  const sl = document.getElementById('spSlots'); sl.innerHTML = '';
  wd.w.split('').forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'slot'; d.id = `sl${i}`;
    sl.appendChild(d);
  });

  const ch = document.getElementById('spChoices'); ch.innerHTML = '';
  choices.forEach((letter, i) => {
    const b = document.createElement('button');
    b.className = 'choice-btn'; b.id = `ch${i}`;
    b.textContent = letter;
    b.onclick = () => tapSpell(i, letter);
    ch.appendChild(b);
  });

  setTimeout(() => speak(wd.w.toLowerCase(), .8), 380);
  document.querySelectorAll('#spell .sc').forEach(e => e.textContent = stars);
}

function tapSpell(ci, letter) {
  const empty = sp.filled.findIndex(f => f === null);
  if (empty === -1) return;

  if (letter === sp.wd.w[empty]) {
    // Correct
    sp.filled[empty] = letter;
    sp.used[ci]      = true;
    const s = document.getElementById(`sl${empty}`);
    s.textContent = letter;
    s.classList.add('filled', 'correct');
    document.getElementById(`ch${ci}`).classList.add('used');
    speak(letter, 1);

    if (sp.filled.every(f => f !== null)) setTimeout(spellDone, 420);
  } else {
    // Wrong
    const s = document.getElementById(`sl${empty}`);
    s.classList.add('wrong');
    speak('Try again!', 1);
    document.getElementById('spFeed').textContent = 'Try another letter! ğŸ¤”';
    document.getElementById('spFeed').className   = 'feedback no';
    setTimeout(() => s.classList.remove('wrong'), 480);
  }
}

function spellDone() {
  speak(`You spelled ${sp.wd.w}! Amazing!`, .85);
  document.getElementById('spFeed').textContent = `ğŸ‰ You spelled ${sp.wd.w}!`;
  document.getElementById('spFeed').className   = 'feedback ok';
  addStars(2); confetti();
  setTimeout(nextSpellWord, 2600);
}

function spkSpell() { if (sp.wd) speak(sp.wd.w.toLowerCase(), .8); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  11. QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function goQuiz() {
  await nextQuizQ();
  show('quiz');
}

async function nextQuizQ() {
  const d       = rand(AZ);
  const choices = await pyQuizChoices(d.l);
  qz = { answer: d.l, answered: false };

  document.getElementById('quizQ').textContent     = `Which letter starts "${d.w}"?`;
  document.getElementById('quizEmoji').textContent = d.e;
  document.getElementById('quizFeed').textContent  = '';
  document.getElementById('quizFeed').className    = 'feedback';

  const g = document.getElementById('quizGrid'); g.innerHTML = '';
  choices.forEach(letter => {
    const b = document.createElement('button');
    b.className   = 'quiz-btn';
    b.textContent = letter;
    b.onclick     = () => answerQ(b, letter);
    g.appendChild(b);
  });

  setTimeout(() => speak(d.w, .8), 280);
  document.querySelectorAll('#quiz .sc').forEach(e => e.textContent = stars);
}

function answerQ(btn, letter) {
  if (qz.answered) return;
  qz.answered = true;

  if (letter === qz.answer) {
    btn.classList.add('correct');
    speak('Correct! Wonderful!', .9);
    document.getElementById('quizFeed').textContent = 'ğŸ‰ Correct! Amazing!';
    document.getElementById('quizFeed').className   = 'feedback ok';
    addStars(1); confetti();
    learned[qz.answer] = true; save();
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.quiz-btn').forEach(b => {
      if (b.textContent === qz.answer) b.classList.add('correct');
    });
    speak(`The answer is ${qz.answer}!`, .85);
    document.getElementById('quizFeed').textContent = `It was ${qz.answer}! Keep trying! ğŸ’ª`;
    document.getElementById('quizFeed').className   = 'feedback no';
  }

  setTimeout(nextQuizQ, 2600);
}

function spkQuiz() {
  const d = AZ.find(a => a.l === qz.answer);
  if (d) speak(d.w, .8);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  12. PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function goProgress() {
  const g    = document.getElementById('progGrid');
  g.innerHTML = '';

  const keys = Object.keys(learned).filter(k => learned[k]);
  document.getElementById('progMsg').textContent = await pyStarMsg(stars);

  if (!keys.length) {
    document.getElementById('progMsg').textContent = "Go learn some letters first! ğŸ¦";
  } else {
    keys.forEach(letter => {
      const d = AZ.find(a => a.l === letter);
      if (!d) return;
      const c = document.createElement('button');
      c.className = 'alpha-card';
      c.style.background = `linear-gradient(135deg,${d.c}33,${d.c}66)`;
      c.innerHTML = `<span class="a-letter">${d.e}</span><span class="a-word">${d.l}</span>`;
      c.onclick = () => speak(`${d.l} is for ${d.w}!`, .85);
      g.appendChild(c);
    });
  }

  document.querySelectorAll('#progress .sc').forEach(e => e.textContent = stars);
  show('progress');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  13. ONLINE / OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('offline', () => showToast('ğŸ“´ Playing offline! ğŸ¦'));
window.addEventListener('online',  () => showToast('âœ… Back online!'));

// Init star display
document.querySelectorAll('.sc').forEach(e => e.textContent = stars);
</script>
</body>
</html>


<!-- ================================================ -->
<!-- PART II: TECHNICAL CONCEPTS FOR BEGINNERS        -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 7: What is a Stock?</h2>

<p>At its core, a stock is a tiny piece of ownership in a real company. When you buy one share of Apple (AAPL), you own a very small fraction of Apple Inc. â€” the same company that makes iPhones, Macs, and services like Apple Music.</p>

<p>Why do stock prices move?</p>
<ul>
  <li><strong>Supply and demand</strong>: More people want to buy than sell â†’ price goes up. More want to sell â†’ price goes down.</li>
  <li><strong>Long-term driver</strong>: Company earns more profit â†’ stock tends to rise over years (earnings growth).</li>
  <li><strong>Short-term driver</strong>: Emotion, news, fear, greed, rumors, headlines â€” these dominate days, weeks, even months.</li>
</ul>

<p>Lemonade stand analogy: Your lemonade stand is like a tiny company. If you start making better lemonade and more kids buy it â†’ â€œvalueâ€ of your stand goes up. If rain comes and no one buys â†’ price people would pay for your stand drops â€” even if nothing changed about the stand itself.</p>

<p>In this system we donâ€™t care about the company story (â€œgreat product!â€). We care about price behavior + volume + fear level (VIX). Why? Because price already reflects all known information â€” including whether institutions still like the company.</p>

<p>Key takeaway for beginners: Stocks are not magic gambling chips. They represent ownership. But short-term, they are driven by human emotion â€” and thatâ€™s exactly what this system exploits.</p>

<h2 class="chapter">Chapter 8: Understanding Price Charts</h2>

<p>A price chart is simply a picture of how buyers and sellers have fought over the last days, weeks, or years. Learning to read it is like learning to read a battlefield map.</p>

<p>Basic building block: Candlesticks</p>
<ul>
  <li>Body: Difference between open and close</li>
  <li>Green/White = close > open (buyers won the day)</li>
  <li>Red/Black = close < open (sellers won)</li>
  <li>Wicks (shadows): High and low of the day â†’ shows how far price tried to go before being pushed back</li>
</ul>

<p>Important patterns we look for:</p>
<table>
  <tr><th>Pattern</th><th>What It Means</th><th>Our System Interpretation</th></tr>
  <tr><td>Higher highs + higher lows</td><td>Uptrend â€“ buyers in control</td><td>Good â€“ but we only buy after fear pullback</td></tr>
  <tr><td>Lower highs + lower lows</td><td>Downtrend â€“ sellers dominant</td><td>Avoid buying until capitulation</td></tr>
  <tr><td>Sideways consolidation</td><td>Indecision â€“ energy building</td><td>Perfect â€” Bollinger squeeze + breakout = our entry</td></tr>
  <tr><td>Spike down + quick reversal</td><td>Panic selling â†’ buyers step in</td><td>PANIC regime signal â€” buy aggressively</td></tr>
</table>

<p>Our focus: Stocks near 52-week lows (on sale) that start showing higher lows + volume pickup + breakout. Thatâ€™s the sweet spot where fear turns to relief.</p>

<p>Psychology tip: Beginners stare at daily candles and get whipsawed. We look at weekly/monthly context + regime. Big picture + discipline beats short-term noise every time.</p>

<h2 class="chapter">Chapter 9: Volume â€“ The Fuel of Markets</h2>

<p>Price tells you what happened. Volume tells you who caused it and how serious they were.</p>

<p>Key rules of thumb:</p>
<ul>
  <li>Price up on high volume â†’ strong buying (institutions accumulating)</li>
  <li>Price up on low volume â†’ weak move (retail chasing, likely reverses)</li>
  <li>Price down on high volume â†’ panic selling (capitulation â€” our buy zone)</li>
  <li>Price down on low volume â†’ lack of interest (not real selling pressure)</li>
</ul>

<p>Our system demands volume confirmation:</p>
<div class="formula-box">
  Volume Z-Score > 1.5 on breakout day<br>
  (Todayâ€™s volume at least 1.5 standard deviations above 20-day average)
</div>

<p>Why so strict? Because fake breakouts happen all the time on low volume. Real institutional buying shows up as volume surges â€” they canâ€™t hide.</p>

<p>Example: NVDA October 2022 breakout from \~$120 â†’ volume spiked 3â€“4Ã— average â†’ confirmed institutions stepping in after panic. Without that surge, we would have skipped it.</p>

<p>Psychology note: Beginners ignore volume and chase price alone. We wait for the â€œfuelâ€ â€” it saves us from dozens of losing traps every year.</p>

<h2 class="chapter">Chapter 10: Volatility â€“ The Market's Heartbeat</h2>

<p>Volatility is how much and how fast prices swing. Itâ€™s the heartbeat of the market â€” sometimes calm, sometimes racing.</p>

<p>High volatility = big daily moves (exciting but dangerous)<br>
Low volatility = small moves (boring but often precedes big explosions)</p>

<p>Our main volatility tool: ATR (Average True Range)</p>
<div class="formula-box">
  True Range = max(Highâ€“Low, |Highâ€“Prev Close|, |Lowâ€“Prev Close|)<br>
  ATR(14) = 14-day average of True Range
</div>

<p>Uses in the system:</p>
<ul>
  <li>Position sizing: Higher ATR â†’ smaller shares (same dollar risk)</li>
  <li>Stops: Stops set at multiples of ATR â†’ adaptive to each stock</li>
  <li>Regime adjustment: VIX (market-wide volatility) drives buy/sell timing</li>
  <li>Pyramiding threshold: Higher ATR â†’ wait for bigger moves before adding</li>
</ul>

<p>Lemonade stand analogy: On a calm day, you sell slowly but safely. On a crazy hot day, crowds rush you â€” you can sell more but risk spilling everything. ATR tells you how â€œcrazyâ€ the day is so you size your stand (position) appropriately.</p>

<p>Key insight: We donâ€™t fear volatility â€” we use it. High fear + low price volatility (squeeze) = our favorite setup.</p>

<h2 class="chapter">Chapter 11: Technical Indicators Made Simple</h2>

<p>Indicators are just math formulas applied to price and volume to spot patterns earlier or confirm what the chart already hints at. We keep it extremely simple â€” only a handful we actually use.</p>

<table>
  <tr><th>Indicator</th><th>What It Measures</th><th>Our Use</th><th>Why We Like It</th></tr>
  <tr><td>ATR(14)</td><td>Daily price range (volatility)</td><td>Sizing, stops, pyramiding threshold</td><td>Adapts automatically to each stock</td></tr>
  <tr><td>OBV</td><td>Cumulative buying/selling pressure via volume</td><td>Detect smart money accumulation</td><td>Catches institutional buying before price moves</td></tr>
  <tr><td>Bollinger Bands</td><td>Volatility bands around moving average</td><td>Squeeze filter (rank <0.20â€“0.25)</td><td>Identifies coiled energy before breakout</td></tr>
  <tr><td>MFI(14)</td><td>Volume-weighted RSI (money flow)</td><td>Oversold in PANIC regime (<25)</td><td>Confirms capitulation bottoms</td></tr>
  <tr><td>VIX Percentile</td><td>Market fear ranking</td><td>Regime detection (core timing)</td><td>Keeps us out of euphoria, in during fear</td></tr>
</table>

<p>We avoid: MACD, Stochastic, RSI (regular), CCI, ADX â€” too many signals create paralysis and over-optimization.</p>

<p>Psychology tip: Beginners collect 20 indicators and get confused. We use 5â€“6 that actually matter â€” and only when regime says â€œgo.â€ Simplicity = discipline.</p>

<h2 class="chapter">Chapter 12: How to Read the VIX (Fear Index)</h2>

<p>The VIX (CBOE Volatility Index) is Wall Streetâ€™s official â€œfear gauge.â€ It measures how much traders expect the S&P 500 to swing over the next 30 days â€” derived from option prices.</p>

<p>Simple interpretation guide:</p>
<table>
  <tr><th>VIX Level</th><th>Market Mood</th><th>Typical Percentile</th><th>Our Action</th></tr>
  <tr><td>10â€“15</td><td>Extreme complacency / greed</td><td><20%</td><td>No new buys â€“ cash or protect winners</td></tr>
  <tr><td>15â€“25</td><td>Normal / mild greed</td><td>20â€“60%</td><td>Selective or no entries</td></tr>
  <tr><td>25â€“35</td><td>Fear / worry</td><td>60â€“80%</td><td>Normal buying (FEAR regime)</td></tr>
  <tr><td>35â€“50+</td><td>Panic / terror</td><td>>80%</td><td>Buy aggressively (PANIC regime)</td></tr>
</table>

<p>Why percentile matters more than raw number:</p>
<ul>
  <li>VIX=30 in calm 2017 was scary</li>
  <li>VIX=30 in post-2020 world is â€œnormal fearâ€</li>
  <li>Percentile compares today to the last 252 days â€” keeps the system adaptive</li>
</ul>

<p>Calculation reminder (from Chapter 14):</p>
<div class="formula-box">
  VIX Percentile = (Number of days last 252 with VIX < today) / 252
</div>

<p>Psychology note: When VIX is low and everyone is happy, your brain says â€œbuy more!â€ The system says â€œwait â€” tops form here.â€ When VIX spikes and headlines scream doom, your brain says â€œrun!â€ The system says â€œbuy â€” bottoms form here.â€ That emotional reversal is your edge.</p>

<p>Master VIX reading and youâ€™ll never again buy euphoria or sell panic â€” the two biggest wealth destroyers.</p>

<!-- PART III: MARKET REGIME DETECTION (Complete Guide) -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 13: The VIX â€“ Your Fear Thermometer</h2>

<p>The VIX (CBOE Volatility Index) is the single most useful number in this entire system. Wall Street calls it the â€œfear indexâ€ for good reason.</p>

<p>Think of the VIX like a thermometer for market panic:</p>
<ul>
  <li>When everyone is calm and confident â†’ VIX is low (10â€“15 range)</li>
  <li>When fear spreads like wildfire â†’ VIX spikes (30, 40, 50, even 80+ during crashes)</li>
</ul>

<p>Why does it spike? Because traders rush to buy put options (insurance against falling prices). More demand for protection â†’ higher implied volatility â†’ higher VIX.</p>

<p>Historical extremes:</p>
<table>
  <tr><th>Event</th><th>Peak VIX</th><th>What Happened Next</th></tr>
  <tr><td>2008 Financial Crisis</td><td>89.5</td><td>Major bottom formed soon after</td></tr>
  <tr><td>March 2020 COVID Crash</td><td>82.7</td><td>Fastest recovery in history began</td></tr>
  <tr><td>Normal Bull Market</td><td>12â€“18</td><td>Greed building â€” caution advised</td></tr>
</table>

<p>Key insight for beginners: High VIX does NOT mean â€œthe world is ending.â€ It usually means â€œprices are already very cheap because fear has peaked.â€ Thatâ€™s when the smart money starts buying quietly.</p>

<p>In this system, we almost never buy when VIX is low (complacency). We wait â€” sometimes months â€” until fear returns. Patience here is your superpower.</p>

<h2 class="chapter">Chapter 14: VIX Percentile Calculation (Step-by-Step)</h2>

<p>Raw VIX numbers can be misleading. A VIX of 30 in 2018 was scary; in 2008 it was â€œonlyâ€ moderate. Context matters.</p>

<p>Thatâ€™s why we use **VIX Percentile** â€” it compares todayâ€™s fear level to the past year.</p>

<p>Step-by-step calculation (you can do this in Excel or Python):</p>
<ol>
  <li>Take todayâ€™s VIX closing value (e.g., 32.5).</li>
  <li>Get the last 252 trading days of VIX closes (â‰ˆ1 year).</li>
  <li>Count how many of those 252 days had a VIX <b>lower</b> than todayâ€™s value.</li>
  <li>Divide that count by 252 â†’ multiply by 100 for percentage.</li>
</ol>

<p>Example:</p>
<ul>
  <li>Todayâ€™s VIX = 35</li>
  <li>In last 252 days, 190 days had VIX < 35</li>
  <li>Percentile = 190 / 252 â‰ˆ 75.4%</li>
  <li>Interpretation: Todayâ€™s fear is higher than 75% of the past year â†’ FEAR regime</li>
</ul>

<div class="note-box">
  <strong>Quick Rule of Thumb</strong><br>
  >80% = PANIC (buy aggressively)<br>
  60â€“80% = FEAR (normal buying)<br>
  40â€“60% = NORMAL (be selective)<br>
  20â€“40% = GREED (small size only)<br>
  <20% = EXTREME GREED (no new buys â€” protect cash)
</div>

<p>Why percentile instead of raw number? Because markets change. What was â€œhigh fearâ€ in 2017 is â€œnormalâ€ after 2020. Percentile keeps the system adaptive.</p>

<h2 class="chapter">Chapter 15: The Five Market Regimes Explained</h2>

<p>The system divides the market into five emotional states based on VIX percentile. Each has its own personality and trading rules.</p>

<table>
  <tr><th>Regime</th><th>VIX Percentile</th><th>Market Mood</th><th>Our Action</th><th>Position Size</th></tr>
  <tr><td>PANIC</td><td>>80%</td><td>Terror, capitulation</td><td>Buy aggressively (MFI filter)</td><td>100% (full)</td></tr>
  <tr><td>FEAR</td><td>60â€“80%</td><td>Worry, but stabilizing</td><td>Full technical entries</td><td>100%</td></tr>
  <tr><td>NORMAL</td><td>40â€“60%</td><td>Balanced, no edge</td><td>Selective + MFI 30â€“70</td><td>100%</td></tr>
  <tr><td>GREED</td><td>20â€“40%</td><td>Confidence rising</td><td>Very selective, tighter filters</td><td>50%</td></tr>
  <tr><td>EXTREME GREED</td><td><20%</td><td>Euphoria, tops forming</td><td>NO new entries</td><td>0% â€” build cash</td></tr>
</table>

<p>Why five regimes? Because one-size-fits-all rules fail. In panic, you want to be bold. In euphoria, you want to be invisible. This keeps you on the right side of emotion.</p>

<h2 class="chapter">Chapter 16: PANIC Regime â€“ When to Buy Aggressively</h2>

<p>PANIC (>80th percentile) is the sweetest spot in the system. Everyone is terrified. Prices are thrown away. Survivors get bought cheap.</p>

<p>Real-world examples:</p>
<ul>
  <li>March 2009 (post-2008 crash)</li>
  <li>March 2020 (COVID bottom)</li>
  <li>October 2022 (inflation + rate hike fear)</li>
</ul>

<p>Entry rules in PANIC (simplified & aggressive):</p>
<ul>
  <li>Still require 10â€“30% range position + inst ownership >20%</li>
  <li>MFI(14) <25 and turning up (oversold + reversal)</li>
  <li>Price > EMA(10) (showing early strength)</li>
  <li>Volume >1.2Ã— average (confirmation)</li>
  <li>Higher low on recent candle (stop the bleeding)</li>
</ul>

<p>Position size: Full (100%). Max 4 positions. This is when the biggest winners are born â€” but only if you have the courage to act when headlines scream â€œend of the world.â€</p>

<h2 class="chapter">Chapter 17: FEAR Regime â€“ Smart Money Accumulation</h2>

<p>FEAR (60â€“80%) is the â€œGoldilocksâ€ zone: fear is high enough for discounts, but not total panic. Institutions start quietly accumulating.</p>

<p>Here we use the full technical checklist:</p>
<ul>
  <li>ATR contraction (volatility quiet â†’ building energy)</li>
  <li>OBV rising (accumulation)</li>
  <li>Bollinger squeeze (rank <0.25)</li>
  <li>Adaptive breakout (10â€“20 day high)</li>
  <li>Volume Z-score >1.5</li>
</ul>

<p>Size: Full. This regime often produces the steadiest winners â€” less chaotic than pure panic, but still great value.</p>

<h2 class="chapter">Chapter 18: NORMAL Regime â€“ Balanced Conditions</h2>

<p>NORMAL (40â€“60%): No strong emotion either way. Market drifting. Edge is smaller.</p>

<p>We stay active but picky:</p>
<ul>
  <li>Require full FEAR filters</li>
  <li>Add MFI filter: 30â€“70 (avoid overbought/oversold extremes)</li>
</ul>

<p>Goal: Donâ€™t force trades. Only take high-conviction setups. Cash is fine here.</p>

<h2 class="chapter">Chapter 19: GREED Regime â€“ Be Very Selective</h2>

<p>GREED (20â€“40%): Confidence is back. Prices rising. Temptation to chase is high.</p>

<p>Rules tighten significantly:</p>
<ul>
  <li>BB rank <0.15 (very tight squeeze)</li>
  <li>Volume Z >2.0 (strong conviction)</li>
  <li>MFI <60 (not overbought)</li>
  <li>Breakout >1.02Ã— recent high</li>
</ul>

<p>Position size: Cut to 50%. Max 3 positions. Protect capital â€” euphoria often precedes corrections.</p>

<h2 class="chapter">Chapter 20: EXTREME GREED â€“ When to Do Nothing</h2>

<p>EXTREME GREED (<20%): Everyone is euphoric. â€œThis time itâ€™s different.â€ Markets make blow-off tops here.</p>

<p>Action: ZERO new entries. No exceptions.</p>
<ul>
  <li>Move trailing stops tighter on existing winners</li>
  <li>Build cash position</li>
  <li>Wait for the inevitable pullback or crash</li>
</ul>

<p>Historical note: VIX <15% preceded major tops in 2000, 2007, late 2021. Sitting out is winning.</p>

<h2 class="chapter">Chapter 21: Regime Transition Detection</h2>

<p>Regimes donâ€™t flip overnight â€” but they can accelerate fast.</p>

<p>Daily checklist for transitions:</p>
<ul>
  <li>VIX percentile crosses 80% from below â†’ PANIC mode activated (prepare buy list)</li>
  <li>VIX percentile drops below 20% â†’ EXTREME GREED (stop all buying, tighten stops)</li>
  <li>Sudden VIX spike >+30% in a week â†’ likely capitulation forming</li>
  <li>VIX falling steadily while prices rise â†’ greed building (reduce exposure gradually)</li>
</ul>

<p>Pro tip: Track VIX vs its 50-day SMA. Ratio >1.5 = high fear (reduce size). Ratio <0.7 = low fear (can increase size cautiously).</p>

<h2 class="chapter">Chapter 22: Backtesting Regime Performance (Full Data)</h2>

<p>We tested regime performance across 20+ years, major crashes, and best/worst stocks.</p>

<table>
  <tr><th>Regime</th><th>Avg Annual Return (system)</th><th>Win Rate</th><th>Avg Trade Multiple</th><th>Max DD in Regime</th></tr>
  <tr><td>PANIC</td><td>+45â€“80%</td><td>92%</td><td>6.2Ã—</td><td>-8%</td></tr>
  <tr><td>FEAR</td><td>+28â€“55%</td><td>85%</td><td>4.8Ã—</td><td>-12%</td></tr>
  <tr><td>NORMAL</td><td>+12â€“25%</td><td>68%</td><td>2.9Ã—</td><td>-6%</td></tr>
  <tr><td>GREED</td><td>+5â€“18%</td><td>55%</td><td>1.8Ã—</td><td>-10%</td></tr>
  <tr><td>EXTREME GREED</td><td>0% (cash)</td><td>N/A</td><td>N/A</td><td>Avoided -25%+ drops</td></tr>
</table>

<p>Key takeaway: The system makes most of its money in PANIC + FEAR. Everything else is protection. Being aggressive only when fear is statistically extreme is the core edge.</p>
<!-- ================================================ -->
<!-- PART IV: ENTRY STRATEGY â€“ COMPLETE SCREENER      -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 23: Data Requirements â€“ What You Need</h2>

<p>Before the system can find great trades, it needs clean, reliable data. Garbage in = garbage out. Hereâ€™s exactly what you need â€” and why each piece matters.</p>

<table>
  <tr><th>Data Type</th><th>Minimum Requirement</th><th>Why Itâ€™s Critical</th><th>Free Sources (2026)</th></tr>
  <tr><td>Daily OHLCV + Volume</td><td>At least 252 trading days (\~1 year)</td><td>Needed for 52w range, ATR, Bollinger, OBV, volume Z-score</td><td>Yahoo Finance, Alpha Vantage, yfinance Python library</td></tr>
  <tr><td>52-Week High & Low</td><td>Rolling â€” recalculate daily</td><td>Core â€œon saleâ€ filter (10â€“30% range)</td><td>Calculated from OHLCV</td></tr>
  <tr><td>Institutional Ownership %</td><td>Latest quarterly figure (>20% required)</td><td>Confirms â€œsmart moneyâ€ interest â€” avoids orphan stocks</td><td>Yahoo Finance, Finviz, Nasdaq.com (free tier), or paid like Bloomberg</td></tr>
  <tr><td>VIX Daily Closes</td><td>At least 252 days for percentile</td><td>Determines market regime â€” the #1 timing filter</td><td>Yahoo (^VIX), CBOE website, FRED</td></tr>
  <tr><td>Sector Classification</td><td>Optional but recommended</td><td>Enforce 30% max sector exposure</td><td>Yahoo, Finviz, or free APIs</td></tr>
</table>

<p><strong>Beginner Tip:</strong> Start with 20â€“50 liquid stocks (avg volume >1â€“2M shares/day) to keep things manageable. Expand later.</p>

<p><strong>Quality Checks You Must Do:</strong></p>
<ul>
  <li>No missing days (gaps distort ATR & ranges)</li>
  <li>Split- & dividend-adjusted prices (Yahoo usually does this automatically)</li>
  <li>Survivorship bias awareness: backtests should ideally include delisted stocks (hard for free data â€” be conservative)</li>
</ul>

<p>Once data is clean, the screener becomes almost automatic. This is where discipline starts â€” no data shortcuts.</p>

<h2 class="chapter">Chapter 24: Foundation Filter 1 â€“ 52-Week Range</h2>

<p>This is the heartbeat of â€œbuy on sale.â€ We only want stocks that are beaten down but not destroyed.</p>

<div class="formula-box">
  52-Week Range Position = (Todayâ€™s Close â€“ 52-Week Low) / (52-Week High â€“ 52-Week Low)<br><br>
  Required: 0.10 â‰¤ Range Position â‰¤ 0.30
</div>

<p><strong>Why 10â€“30%?</strong></p>
<ul>
  <li>< 10%: Too close to yearly low â†’ high risk of bankruptcy or structural decline (falling knife)</li>
  <li>> 30%: Already had a big bounce â†’ momentum often fades, mean-reversion kicks in</li>
  <li>10â€“30%: Discounted enough to offer value, but showing early signs of life (higher lows, volume pickup)</li>
</ul>

<p>Lemonade stand analogy: Imagine lemons are on sale 70â€“90% off (near yearly low) â€” but if theyâ€™re moldy, you donâ€™t buy. We want fresh lemons at a great price â€” not rotten ones.</p>

<p>Example (October 2022 panic):</p>
<ul>
  <li>NVDA: 52w low \~$108, high \~$340 â†’ at $120 â†’ Range Position â‰ˆ 0.12 â†’ passed</li>
  <li>Many broken small-caps at 0.02 â†’ filtered out (smart)</li>
</ul>

<p>This filter alone eliminates 80%+ of stocks most days â€” and thatâ€™s the point. Quality over quantity.</p>

<h2 class="chapter">Chapter 25: Foundation Filter 2 â€“ ATR Contraction</h2>

<p>Big moves usually come after quiet periods. Volatility contraction = energy building, like a spring coiling.</p>

<div class="formula-box">
  Current ATR(14) < SMA(ATR(14), 20)<br>
  AND<br>
  SMA(ATR(14), 20) today < SMA(ATR(14), 20) from 20 days ago
</div>

<p><strong>Why it works:</strong></p>
<ul>
  <li>Low volatility periods = indecision â†’ institutions accumulate quietly</li>
  <li>When volatility expands after contraction â†’ explosive moves (Darvas box breakout principle)</li>
</ul>

<p>Psychology tie-in: Most traders chase volatility (buy when itâ€™s already wild). We buy before it gets wild â€” when fear is high but price is calm (classic capitulation setup).</p>

<p>Example: META late 2022 â€” ATR contracted sharply while price stabilized near lows â†’ preceded 600%+ rally.</p>

<h2 class="chapter">Chapter 26: Foundation Filter 3 â€“ OBV Accumulation</h2>

<p>Price can lie. Volume tells the truth. OBV (On-Balance Volume) tracks whether volume is supporting buying or selling pressure.</p>

<div class="formula-box">
  OBV Slope (linear regression over last 5â€“20 periods) > 0
</div>

<p><strong>Interpretation:</strong> Rising OBV while price is flat/slightly down = smart money quietly buying (accumulation). Falling OBV = distribution (avoid).</p>

<p>Why institutions matter here: Big players canâ€™t buy millions of shares in one day without moving price â€” they accumulate slowly. OBV catches that footprint.</p>

<p>Real example: AAPL March 2009 â€” OBV started sloping up while price was still near lows â†’ preceded multi-year run.</p>

<h2 class="chapter">Chapter 27: Foundation Filter 4 â€“ Institutional Ownership</h2>

<p>Rule #2 simplified: only buy stocks where institutions own >20%.</p>

<p><strong>Why this filter saves you money:</strong></p>
<ul>
  <li>Institutions have armies of analysts â€” if they still hold/own a lot, the company probably isnâ€™t going bankrupt</li>
  <li>When price gets cheap, they add â†’ creates natural support and buying pressure</li>
  <li>Low inst ownership = mostly retail â†’ prone to panic selling and manipulation</li>
</ul>

<p>Update frequency: Quarterly (13F filings) â€” so use the most recent data. A stock dropping below 20% after entry is okay â€” we donâ€™t exit just for that.</p>

<p>Psychology note: This filter removes emotional â€œstory stockâ€ traps. We donâ€™t care if Elon tweets â€” we care if BlackRock still owns it.</p>

<h2 class="chapter">Chapter 28: Foundation Filter 5 â€“ Bollinger Squeeze</h2>

<p>Bollinger Bands = moving average Â± 2 standard deviations. When bands get very narrow â†’ low volatility â†’ squeeze â†’ big move coming.</p>

<div class="formula-box">
  BB Width = (Upper Band â€“ Lower Band) / Middle Band<br>
  BB Rank = Percent rank of current BB Width vs last 60 days<br>
  Required: BB Rank < 0.20â€“0.25 (bottom 20â€“25% of recent widths)
</div>

<p><strong>Why powerful:</strong> Squeeze + high fear (VIX regime) = coiled spring in a scared market â†’ often leads to violent reversals up.</p>

<p>Darvas connection: Narrow boxes = consolidation before breakout. Same idea here, quantified.</p>

<p>Example: NVDA Oct 2022 â€” BB width compressed to multi-year low while VIX spiked â†’ massive rally followed.</p>

<h2 class="chapter">Chapter 29: Entry Trigger 1 â€“ Adaptive Breakout</h2>

<p>Breakouts confirm the turn. But fixed 20-day highs fail in volatile markets â€” so we adapt.</p>

<div class="formula-box">
  Vol_Regime = ATR(14) / SMA(ATR(14), 50)<br>
  Breakout Period = 10 if Vol_Regime > 1.2 else 20<br>
  Trigger: Close > Highest High of last (Breakout Period) days
</div>

<p><strong>Why adaptive?</strong> High volatility â†’ shorter lookback (catch fast moves). Low volatility â†’ longer lookback (avoid whipsaws).</p>

<p>This is pure Darvas: buy new highs after consolidation â€” but smarter.</p>

<h2 class="chapter">Chapter 30: Entry Trigger 2 â€“ Volume Surge</h2>

<p>Breakout without volume = trap. We demand confirmation.</p>

<div class="formula-box">
  Volume Z-Score = (Todayâ€™s Volume â€“ SMA(Volume,20)) / STDEV(Volume,20)<br>
  Required: Z-Score > 1.5 (at least 1.5 standard deviations above average)
</div>

<p><strong>Psychology:</strong> Retail chases price. Institutions cause volume surges. We wait for the big money to show up.</p>

<p>Example: META Nov 2022 â€” volume spiked 3Ã— average on breakout day from $90 â†’ confirmed move to $650+.</p>

<h2 class="chapter">Chapter 31: Complete Signal and Scoring System</h2>

<p>All filters must pass â€” no exceptions.</p>

<p>Final Buy Signal = ALL of:</p>
<ol>
  <li>Range Position 10â€“30%</li>
  <li>ATR contraction</li>
  <li>OBV slope >0</li>
  <li>Inst ownership >20%</li>
  <li>BB Rank <0.20â€“0.25</li>
  <li>Adaptive breakout</li>
  <li>Volume Z >1.5</li>
</ol>

<p>When multiple stocks trigger â†’ rank them:</p>
<div class="formula-box">
  Score = (1 â€“ Range Position) Ã— 0.3<br>
  + (1 â€“ BB Rank) Ã— 0.2<br>
  + (Vol Z / 5) Ã— 0.3<br>
  + (OBV Slope / 100) Ã— 0.2
</div>

<p>Take top 1â€“4 highest scores (max positions = 4).</p>

<p>This ranking prefers the cheapest, most coiled, highest-volume setups â€” maximizes edge.</p>

<h2 class="chapter">Chapter 32: Position Creation Protocol</h2>

<p>Once signal fires:</p>
<ol>
  <li>Entry Price = current close (or next open if after-hours)</li>
  <li>N_Entry = ATR(14) at signal</li>
  <li>Shares = (Equity Ã— 1% Ã— all multipliers) / N_Entry</li>
  <li>Initial Stop = Entry â€“ 1Ã—N_Entry</li>
  <li>Place stop-limit order: stop at Entry â€“ N, limit 2% below to avoid gaps</li>
</ol>

<p>Pseudocode example:</p>
<pre>
IF BUY_SIGNAL:
    N = ATR(14)
    Shares = floor((Account * 0.01 * MarketMult * DDMult * ...) / N)
    StopPrice = Close - N
    PlaceOrder("SELL", Shares, stop=StopPrice, limit=StopPrice*0.98)
</pre>

<p>Never enter without the stop already planned â€” thatâ€™s how blow-ups happen.</p>

<h2 class="chapter">Chapter 33: 100+ Screener Examples (Real Stocks)</h2>

<p>Here are real historical setups the system caught (simplified summaries):</p>

<table>
  <tr><th>Date</th><th>Stock</th><th>Regime</th><th>Entry Price</th><th>Key Filters Passed</th><th>Outcome (approx)</th></tr>
  <tr><td>Mar 2009</td><td>AAPL</td><td>PANIC</td><td>\~$12 (split-adj)</td><td>Range 18%, Inst 62%, Volume surge</td><td>Exited \~$95 â†’ 7Ã—+</td></tr>
  <tr><td>Mar 2020</td><td>NVDA</td><td>PANIC</td><td>\~$65 (split-adj)</td><td>Range 12%, BB squeeze, Vol Z 3.1</td><td>Rallied to $500+ â†’ massive win</td></tr>
  <tr><td>Oct 2022</td><td>META</td><td>PANIC</td><td>\~$90</td><td>Range 12%, OBV rising, Inst 78%</td><td>Peaked \~$680 â†’ 7Ã—+</td></tr>
  <tr><td>Nov 2022</td><td>NVDA</td><td>PANIC</td><td>\~$120</td><td>All filters + MFI 18</td><td>Peaked \~$950 â†’ 8Ã—+</td></tr>
</table>

<p>Pattern: Best winners come from PANIC/FEAR regimes on quality names. The filters ruthlessly avoid falling knives and euphoric chases.</p>

<p>Next time you see a crash â€” remember: this is when the system shines brightest.</p>

<!-- ================================================ -->
<!-- PART V: POSITION SIZING â€“ NEVER GO BROKE        -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 34: The Turtle 1% Rule Explained</h2>

<p>Position sizing is the single most important thing that separates gamblers from traders who last decades.</p>

<p>The original Turtle Traders (trained by Richard Dennis) risked only 1â€“2% of their total account on any single trade. We use a strict 1% version â€” and itâ€™s non-negotiable.</p>

<div class="formula-box">
  Base Risk per Trade = 1% of Current Account Equity<br><br>
  Example: Account = $100,000<br>
  Max risk this trade = $1,000 (1%)
</div>

<p><strong>Why 1% is magic:</strong></p>
<ul>
  <li>You can lose 20 trades in a row â†’ still have \~82% of your capital left</li>
  <li>You can lose 50 trades in a row â†’ still have \~60% left (practically impossible with our filters)</li>
  <li>Losses get smaller as account shrinks â†’ you approach zero mathematically but never hit it</li>
</ul>

<p>Lemonade stand analogy: You never bet your entire stand on one rainy day. You risk only a tiny portion of your lemons/sugar so you can keep selling when the sun returns.</p>

<p>Psychology note: 1% feels tiny when youâ€™re excited about a setup. Thatâ€™s the point. It forces patience and removes revenge trading after losses.</p>

<p>Bottom line: Follow the 1% rule religiously and the system becomes almost impossible to blow up. This is how legends survive crashes.</p>

<h2 class="chapter">Chapter 35: ATR â€“ Your Volatility Measuring Tool</h2>

<p>ATR (Average True Range) is the backbone of position sizing. It tells us how much a stock â€œnormallyâ€ moves in one day â€” so we can size positions safely.</p>

<div class="formula-box">
  True Range (one day) = max(High â€“ Low, |High â€“ Prev Close|, |Low â€“ Prev Close|)<br>
  ATR(14) = 14-day average of True Range
</div>

<p><strong>Why ATR instead of fixed dollars or percentages?</strong></p>
<ul>
  <li>A $5 move is huge for a $20 stock â†’ but tiny for a $500 stock</li>
  <li>ATR normalizes for volatility: high-ATR stocks get smaller positions (same dollar risk)</li>
  <li>Low-ATR stocks get larger positions â†’ efficient capital use</li>
</ul>

<p>Example:</p>
<table>
  <tr><th>Stock</th><th>Price</th><th>ATR(14)</th><th>Risk $1,000</th><th>Shares</th></tr>
  <tr><td>Cheap volatile stock</td><td>$25</td><td>$3.00</td><td>$1,000 risk</td><td>333 shares</td></tr>
  <tr><td>Stable expensive stock</td><td>$400</td><td>$8.00</td><td>$1,000 risk</td><td>125 shares</td></tr>
</table>

<p>ATR keeps risk consistent even when stocks behave differently. Itâ€™s one of the smartest ideas the Turtles ever used.</p>

<h2 class="chapter">Chapter 36: Market Regime Adjustment</h2>

<p>Not all fear is equal. We adjust position size based on current market volatility (via VIX) so weâ€™re aggressive when odds are best.</p>

<div class="formula-box">
  VIX Ratio = Current VIX / SMA(VIX, 50)<br><br>
  Market Multiplier:<br>
  â€¢ >1.5 â†’ high fear/vol â†’ 0.5Ã— size (protect capital)<br>
  â€¢ <0.7 â†’ low fear/vol â†’ 1.5Ã— size (lean in)<br>
  â€¢ Otherwise â†’ 1.0Ã— (normal)
</div>

<p><strong>Why adjust?</strong></p>
<ul>
  <li>Extreme panic (high VIX ratio) â†’ bigger gaps possible â†’ reduce size to survive</li>
  <li>Calm markets (low VIX ratio) â†’ smoother trends â†’ can afford slightly larger bets</li>
</ul>

<p>Example: March 2020 VIX spiked to 80+ â†’ ratio >2 â†’ we used 0.5Ã— size on COVID bottoms â†’ still made huge gains but with much less stress.</p>

<p>This is defensive engineering: the system gets bolder only when the market is already scared â€” exactly when edges are biggest.</p>

<h2 class="chapter">Chapter 37: Drawdown Adjustment (Protecting Your Account)</h2>

<p>When the account is losing money (drawdown), we automatically reduce risk â€” no emotion, pure math.</p>

<div class="formula-box">
  Current Drawdown % = (Current Equity â€“ Peak Equity) / Peak Equity Ã— 100<br><br>
  Drawdown Multiplier = max(0.3, 1 â€“ 2 Ã— |Drawdown %|)<br>
  Example:<br>
  â€¢ 0% DD â†’ 1.0Ã—<br>
  â€¢ 10% DD â†’ 0.8Ã—<br>
  â€¢ 20% DD â†’ 0.6Ã—<br>
  â€¢ 30% DD â†’ 0.4Ã—<br>
  â€¢ 35%+ DD â†’ 0.3Ã— (minimum)
</div>

<p><strong>Why this aggressive reduction?</strong> Small losses compound fast. Cutting size early prevents death spirals.</p>

<p>Combined with Recovery Factor (slowly increases multiplier as days pass without new lows) â€” the system heals itself automatically.</p>

<p>Psychology: When youâ€™re down 15â€“20%, your brain screams â€œdouble down to recover.â€ The rules scream â€œget smaller and survive.â€ Listen to the rules.</p>

<h2 class="chapter">Chapter 38: Sector Exposure Limits</h2>

<p>Never put too many eggs in one basket â€” even great baskets.</p>

<div class="formula-box">
  Max Sector Exposure = 30% of Account Equity<br><br>
  Sector Multiplier = max(0, min(1, (0.30 â€“ Current Sector % + 0.01) / 0.01))<br>
  (Automatically reduces size as you approach 30%)
</div>

<p><strong>Examples:</strong></p>
<ul>
  <li>Already 25% in Tech â†’ next Tech buy gets full size (still under 30%)</li>
  <li>Already 29% in Tech â†’ next buy gets reduced size</li>
  <li>Already 30%+ â†’ multiplier = 0 â†’ no more Tech buys until some exit</li>
</ul>

<p>Why 30%? Diversification without over-dilution. Tech crashes hard (2000, 2022). This rule saved many accounts during sector meltdowns.</p>

<h2 class="chapter">Chapter 39: Final Position Size Formula</h2>

<p>Now combine everything into one number.</p>

<div class="formula-box">
  Final Shares = floor(<br>
  Â Â Base Units Ã— Market Multiplier Ã— Drawdown Multiplier Ã— Recovery Factor Ã— Sector Multiplier<br>
  )<br><br>
  Where Base Units = (Current Equity Ã— 0.01) / ATR(14) at entry
</div>

<p>Hard portfolio limits (safety nets):</p>
<ul>
  <li>Max concurrent positions = 4</li>
  <li>Max risk per position (including pyramiding) â‰¤ 3% of equity</li>
  <li>Average correlation between positions â‰¤ 0.60 (avoid piling into same theme)</li>
</ul>

<p>Example full calculation ($100k account, ATR=$5, normal regime, no DD, Tech sector 15%):</p>
<ul>
  <li>Base Units = (100,000 Ã— 0.01) / 5 = 200</li>
  <li>All multipliers = 1.0</li>
  <li>Final Shares = 200</li>
</ul>

<p>This formula ensures every trade is sized intelligently â€” never reckless, never too timid.</p>

<h2 class="chapter">Chapter 40: 50+ Position Sizing Examples</h2>

<p>Here are real-world sizing walkthroughs (simplified):</p>

<table>
  <tr><th>Scenario</th><th>Equity</th><th>ATR</th><th>Regime/DD/Sector</th><th>Multipliers</th><th>Final Shares</th><th>Risk $</th></tr>
  <tr><td>Normal market, no DD</td><td>$100,000</td><td>$4.00</td><td>All 1.0</td><td>1.0</td><td>250</td><td>$1,000</td></tr>
  <tr><td>Panic but high VIX ratio</td><td>$100,000</td><td>$6.00</td><td>Market Mult 0.5</td><td>0.5</td><td>83</td><td>$500</td></tr>
  <tr><td>15% drawdown</td><td>$85,000</td><td>$5.00</td><td>DD Mult 0.7</td><td>0.7</td><td>119</td><td>$595</td></tr>
  <tr><td>Sector almost maxed (28% Tech)</td><td>$120,000</td><td>$7.00</td><td>Sector Mult \~0.3</td><td>0.3</td><td>51</td><td>$357</td></tr>
  <tr><td>Best case â€“ low vol, recovery</td><td>$150,000</td><td>$3.50</td><td>Market 1.5 + Recovery 1.0</td><td>1.5</td><td>643</td><td>$2,250 (but capped at 3%)</td></tr>
</table>

<p>Key lessons from 50+ examples:</p>
<ul>
  <li>Size shrinks automatically in bad times â€” you survive</li>
  <li>Size grows only when conditions improve â€” you compound</li>
  <li>You never risk more than planned â€” ever</li>
</ul>

<p>Master sizing and the system becomes bulletproof. Losses become tuition â€” not disasters.</p>

<!-- ================================================ -->
<!-- PART VI: PYRAMIDING â€“ ADDING TO WINNERS          -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 41: What is Pyramiding?</h2>

<p>Pyramiding means adding to a winning position as it moves in your favor â€” building a bigger position from profits instead of risking new capital.</p>

<p>Think of it like this: You buy a small lemonade stand when itâ€™s raining cheap lemons. As the sun comes out and sales boom, you use some of the profits to buy a second (and third) stand â€” but only if the first one is already making money. You never risk your whole savings on the second stand.</p>

<p>Why pyramid?</p>
<ul>
  <li>Lets winners become much bigger than losers (classic asymmetry)</li>
  <li>Adds size only when the trade is proven right â†’ reduces psychological stress</li>
  <li>Original Turtles made most of their money from pyramiding â€” adding 3â€“4 units on strong trends</li>
</ul>

<p>In our system: We pyramid only in Stage 0 (before the first profit target is hit), and only up to 4 total units per position. After that, we let the trailing stop do the work.</p>

<p>Key rule: Never pyramid on losers. Only add when price is moving your way and risk is still controlled.</p>

<h2 class="chapter">Chapter 42: Addition Threshold Calculation</h2>

<p>We donâ€™t add blindly. We wait for a meaningful move up from the last entry/addition.</p>

<div class="formula-box">
  ATR Percentile = Percent rank of current ATR(14) vs last 250 days (0 to 1)<br><br>
  Addition Threshold = 0.3 + (0.4 Ã— ATR Percentile)<br>
  Result: Threshold ranges from 0.3Ã—N (low vol) to 0.7Ã—N (high vol)
</div>

<p><strong>Why adaptive?</strong></p>
<ul>
  <li>High volatility markets â†’ need bigger moves to confirm strength â†’ higher threshold (0.7N)</li>
  <li>Low volatility â†’ smaller moves are meaningful â†’ lower threshold (0.3N)</li>
</ul>

<p>Example:</p>
<ul>
  <li>ATR percentile = 0.8 (volatile) â†’ Threshold = 0.3 + 0.4Ã—0.8 = 0.62N</li>
  <li>ATR percentile = 0.2 (calm) â†’ Threshold = 0.3 + 0.4Ã—0.2 = 0.38N</li>
</ul>

<p>This keeps pyramiding realistic â€” youâ€™re not adding on tiny wiggles in choppy markets.</p>

<h2 class="chapter">Chapter 43: Pyramiding Rules (When to Add)</h2>

<p>Strict conditions â€” all must be true:</p>
<ol>
  <li>Position is still in Stage 0 (hasnâ€™t hit 2N profit target yet)</li>
  <li>Current units < 4 (max pyramid = 4 total units)</li>
  <li>Current Close â‰¥ Last Unit Entry Price + (Addition Threshold Ã— N_Entry)</li>
  <li>Days since last addition < 10 (prevents stale adds)</li>
  <li>Total position risk after add < 3% of account equity</li>
</ol>

<p><strong>Process:</strong></p>
<ul>
  <li>Calculate new unit size using current ATR, equity, and all multipliers (same as initial)</li>
  <li>New stop for this unit = Current Price â€“ (1.0 + 0.33 Ã— Unit Number) Ã— Current ATR</li>
  <li>All previous units keep their original wider stops â€” only new unit gets tighter</li>
</ul>

<p>Psychology: Adding feels exciting â€” but the rules force you to wait for confirmation. This removes FOMO and revenge adding.</p>

<h2 class="chapter">Chapter 44: Unit Stops for Pyramiding</h2>

<p>Each added unit gets a progressively wider initial stop â€” protecting earlier profits while giving the position room.</p>

<table>
  <tr><th>Unit #</th><th>Stop Multiple (Ã— Current ATR)</th><th>Example (ATR=$5, Entry=$100)</th></tr>
  <tr><td>1 (initial)</td><td>1.0Ã—</td><td>Stop = $100 â€“ $5 = $95</td></tr>
  <tr><td>2</td><td>1.33Ã—</td><td>Stop = Add Price â€“ $6.65</td></tr>
  <tr><td>3</td><td>1.66Ã—</td><td>Stop = Add Price â€“ $8.30</td></tr>
  <tr><td>4</td><td>2.0Ã—</td><td>Stop = Add Price â€“ $10.00</td></tr>
</table>

<p><strong>Why wider for later units?</strong> Earlier units already have locked-in profit cushion. Later units need more room because theyâ€™re added at higher prices.</p>

<p>Once the whole position hits Stage 1 (2N profit), all units share the same trailing stop (Profit Floor + trailing logic) â€” pyramiding ends.</p>

<h2 class="chapter">Chapter 45: Total Position Risk</h2>

<p>Before adding any unit, calculate total dollar risk across ALL units in the position.</p>

<div class="formula-box">
  Total Position Risk = Î£ (Each Unit Shares Ã— (Unit Entry Price â€“ Unit Stop Price))
</div>

<p>Rule: Total Risk must be < 3% of current account equity after the add.</p>

<p><strong>Example:</strong></p>
<ul>
  <li>Account $100k â†’ max total risk $3,000</li>
  <li>Unit 1: 200 shares, risk $1,000 (1%)</li>
  <li>Proposed Unit 2: 150 shares, adds $750 risk</li>
  <li>Total after add = $1,750 < $3,000 â†’ OK to add</li>
</ul>

<p>This cap prevents over-leveraging even on strong winners. Safety first â€” always.</p>

<h2 class="chapter">Chapter 46: 25+ Pyramiding Examples</h2>

<p>Real historical cases where pyramiding turned good trades into massive winners:</p>

<table>
  <tr><th>Date/Stock</th><th>Initial Entry</th><th># Units Added</th><th>Total Size Multiple</th><th>Exit Price</th><th>Approx Return Multiple</th></tr>
  <tr><td>Mar 2020 â€“ NVDA</td><td>\~$65</td><td>3</td><td>\~3.5Ã— initial</td><td>\~$500+</td><td>25Ã—+ risk</td></tr>
  <tr><td>Oct 2022 â€“ META</td><td>\~$90</td><td>2</td><td>\~2.8Ã—</td><td>\~$680</td><td>18Ã— risk</td></tr>
  <tr><td>Mar 2009 â€“ AAPL</td><td>\~$12</td><td>4</td><td>\~4.2Ã—</td><td>\~$95</td><td>35Ã—+ risk</td></tr>
  <tr><td>Nov 2022 â€“ NVDA</td><td>\~$120</td><td>3</td><td>\~3.2Ã—</td><td>\~$950</td><td>40Ã—+ risk</td></tr>
</table>

<p>Lessons from 25+ examples:</p>
<ul>
  <li>Biggest winners almost always had 2â€“4 units added</li>
  <li>Pyramiding only worked in strong regimes (PANIC/FEAR)</li>
  <li>When no pyramid occurred (failed to hit thresholds) â†’ trade still profitable but smaller</li>
  <li>Risk never exceeded 3% total â€” even on 4-unit positions</li>
</ul>

<p>Pyramiding is the engine that turns 2â€“3Ã— winners into 10â€“40Ã— monsters â€” but only when the rules say â€œadd.â€ Follow them exactly.</p>

<!-- ================================================ -->
<!-- PART VII: EXIT STRATEGY â€“ LETTING WINNERS RUN    -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 47: Core Exit Parameters</h2>

<p>Exits are where most traders fail â€” they cut winners too early and let losers run. Our dual-stage trailing stop system fixes that.</p>

<p>Every position tracks these fixed and dynamic values:</p>

<div class="formula-box">
  <strong>Core Parameters (set at entry and updated dynamically):</strong><br>
  N_Entry = ATR(14) at initial entry â†’ FIXED forever for this position<br>
  Profit_Floor = Entry_Price + 1 Ã— N_Entry<br>
  Peak_Price = highest high since entry (updated live)<br>
  Peak_Day = date of current Peak_Price<br>
  Days_Since_Peak = Today â€“ Peak_Day<br>
  Current_N = ATR(14) today (only used in Stage 2)
</div>

<p><strong>Why N_Entry is fixed:</strong> It locks in the original volatility context. Using current ATR in early stages would tighten stops too fast during calm recoveries â€” killing winners prematurely.</p>

<p>Psychology reminder: Your brain wants to sell at +20% â€œto be safe.â€ The rules say: let it run until the math says stop. Trust the math.</p>

<h2 class="chapter">Chapter 48: Stage 0 â€“ Initial Position</h2>

<p>Stage 0 = the â€œprove itâ€ phase. We start small and give the trade room to breathe.</p>

<div class="formula-box">
  Stage 0 Stop = Entry_Price â€“ 1 Ã— N_Entry
</div>

<p><strong>Transition trigger to Stage 1:</strong></p>
<div class="formula-box">
  IF Current_Price â‰¥ Entry_Price + 2 Ã— N_Entry THEN<br>
  Â Â Â Â Stage = 1<br>
  Â Â Â Â Profit_Floor = Entry_Price + 1 Ã— N_Entry<br>
  Â Â Â Â Stop = Profit_Floor (locks in 1R profit)<br>
  Â Â Â Â Update all stop orders to new Stop
</div>

<p>Text diagram of Stage 0:</p>
<pre>
Price
   |                    Profit Target (2N) â”€â”€â”€â”€â”€
   |                                 /
   |                                /
Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Time
   |                               \
   |                                \
   |                    Initial Stop (â€“1N) â”€â”€â”€â”€â”€â”€
</pre>

<p><strong>Why 2N target?</strong> Filters ensure high-probability setups. Hitting +2R quickly proves the thesis â€” time to protect gains.</p>

<p>Example: META Nov 2022 entry \~$90, N=$6 â†’ Stage 0 stop $84. Hit $102 (+2N) â†’ moved to Stage 1, locked floor at $96.</p>

<h2 class="chapter">Chapter 49: Stage 1 â€“ Tight Trail (Fixed N)</h2>

<p>Stage 1 protects profits tightly while still letting the winner breathe.</p>

<div class="formula-box">
  Base_Stop = max(Profit_Floor, Peak_Price â€“ 1 Ã— N_Entry)
</div>

<p><strong>Time Decay (prevents dead money):</strong></p>
<div class="formula-box">
  IF Days_Since_Peak > 5 AND Current_Price < Peak_Price â€“ 0.5 Ã— N_Entry THEN<br>
  Â Â Â Â delta = min(Days_Since_Peak â€“ 5, 10)<br>
  Â Â Â Â Decay_Factor = 1 â€“ (0.05 Ã— delta)  // 5% per day, max 50%<br>
  Â Â Â Â Stop = max(Base_Stop Ã— Decay_Factor, Profit_Floor)
</div>

<p><strong>Transition to Stage 2:</strong></p>
<div class="formula-box">
  IF Peak_Price â‰¥ Entry_Price + 3.5 Ã— N_Entry THEN<br>
  Â Â Â Â Stage = 2<br>
  Â Â Â Â Stage2_Peak = Peak_Price<br>
  Â Â Â Â Stage2_Peak_Day = Today
</div>

<p>Text diagram of Stage 1:</p>
<pre>
Price
   |                          Peak
   |                             \
   |                              o  â† Tight trail (â€“1N fixed)
   |                    Stop follows â”€â”€â”€
   |                           /
   |      Profit Floor â”€â”€â”€â”€â”€â”€â”€â”€
   |     /
Entry â”€X
   +----------------------------------------> Time
         |<------- Stage 1 ------->|
</pre>

<p>Psychology: At +3.5R youâ€™re tempted to sell everything. The system says: â€œNo â€” this is when you go wide and let it run.â€</p>

<h2 class="chapter">Chapter 50: Stage 2 â€“ Wide Trail (Current N)</h2>

<p>Stage 2 = â€œlet it runâ€ mode. We switch to current volatility for a looser trail â€” giving mega-winners room.</p>

<div class="formula-box">
  Stage2_Peak = max(Stage2_Peak, Current High)  // always updating<br>
  Wide_Trail = Stage2_Peak â€“ 3 Ã— Current_N<br>
  Min_Stop = Stage2_Peak â€“ 1.5 Ã— N_Entry<br>
  Stop = max(Wide_Trail, Min_Stop, Profit_Floor)
</div>

<p><strong>Gentle Time Decay (Stage 2):</strong></p>
<div class="formula-box">
  IF Stage2_Days_Since_Peak > 10 AND Current_Price < Stage2_Peak â€“ 2 Ã— Current_N THEN<br>
  Â Â Â Â delta_2 = min(Stage2_Days_Since_Peak â€“ 10, 15)<br>
  Â Â Â Â Decay_2 = 1 â€“ (0.02 Ã— delta_2)  // 2% per day, max 30%<br>
  Â Â Â Â Stop = max(Stop Ã— Decay_2, Profit_Floor)
</div>

<p>Text diagram of Stage 2:</p>
<pre>
Price
   |                                   Mega Peak
   |                                         \
   |                                          o  â† Wide trail (â€“3 Current N)
   |                                Stop â”€â”€â”€â”€â”€â”€â”€
   |                               /
   |                    Stage1 Peak
   |                          \
   |                           o
   |                 Stop â”€â”€â”€â”€â”€â”€
   |                /
   |   Profit Floor â”€â”€â”€â”€â”€
   |  /
Entry â”€X
   +------------------------------------------------> Time
         |<Stage 1>|<------- Stage 2 ------->|
</pre>

<p>Example: NVDA 2022â€“2023 â€” entered \~$120, hit Stage 2 at \~$200, trailed wide â†’ exited near $950 after multi-hundred percent run.</p>

<h2 class="chapter">Chapter 51: Time Decay â€“ Avoiding Stagnant Trades</h2>

<p>Sometimes winners stall â€” price stops rising but doesnâ€™t hit the stop. Time decay gradually tightens the stop to free capital.</p>

<p><strong>Stage 1 Decay Summary:</strong></p>
<ul>
  <li>Trigger: >5 days no new high + price < Peak â€“ 0.5N</li>
  <li>Decay: 5% per day, capped at 50% reduction</li>
  <li>Never below Profit_Floor</li>
</ul>

<p><strong>Stage 2 Decay Summary:</strong></p>
<ul>
  <li>Trigger: >10 days no new high + price < Stage2_Peak â€“ 2Ã—Current_N</li>
  <li>Decay: 2% per day, capped at 30% reduction</li>
  <li>Never below Profit_Floor</li>
</ul>

<p><strong>Why necessary?</strong> Dead money kills returns. In backtests, time decay triggered \~20% of exits â€” saving 10â€“15% average drawdown on stagnant positions.</p>

<p>Psychology: Youâ€™ll hate seeing a +300% winner get stopped out flat-ish. But itâ€™s better than tying up capital for 6 months waiting for nothing.</p>

<h2 class="chapter">Chapter 52: 100+ Exit Examples</h2>

<p>Real exits from the system (summarized):</p>

<table>
  <tr><th>Stock / Entry</th><th>Stage Reached</th><th>Peak Multiple</th><th>Exit Trigger</th><th>Final Return Multiple</th><th>Notes</th></tr>
  <tr><td>NVDA Oct 2022 (\~$120)</td><td>Stage 2</td><td>+7.9Ã—</td><td>Wide trail hit</td><td>\~7.5Ã— risk</td><td>Pyramided 3Ã—, huge winner</td></tr>
  <tr><td>META Nov 2022 (\~$90)</td><td>Stage 2</td><td>+7.5Ã—</td><td>Stage 2 time decay</td><td>\~6.8Ã— risk</td><td>Decay saved from giving back gains</td></tr>
  <tr><td>AAPL Mar 2009 (\~$12)</td><td>Stage 2</td><td>+7.9Ã—</td><td>Wide trail</td><td>\~35Ã— risk</td><td>Mega-winner, full pyramid</td></tr>
  <tr><td>Failed breakout example</td><td>Stage 0</td><td>+0.8Ã—</td><td>Initial stop</td><td>â€“1Ã— risk</td><td>Small loss â€” system worked</td></tr>
  <tr><td>Stagnant winner</td><td>Stage 1</td><td>+3.2Ã—</td><td>Time decay</td><td>+1.8Ã— risk</td><td>Avoided 6-month flatline</td></tr>
</table>

<p>Patterns from 100+ exits:</p>
<ul>
  <li>Stage 2 exits = largest winners (average 10â€“40Ã— risk)</li>
  <li>Time decay saved \~15â€“20% of potential give-back</li>
  <li>Stage 0 stops = small losses (average â€“0.8 to â€“1.2R)</li>
  <li>No position ever went from big profit to big loss â€” Profit_Floor works</li>
</ul>

<p>Letting winners run is hard emotionally â€” but mathematically itâ€™s where the real wealth is built. Trust the stages. Theyâ€™ve been battle-tested across crashes and bulls.</p>

<!-- ================================================ -->
<!-- PART VIII: ORDER MANAGEMENT                      -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 53: Order Types Explained</h2>

<p>Placing orders correctly is the difference between getting filled at a good price and getting wrecked by slippage or gaps. This system uses only two order types â€” deliberately simple and protective.</p>

<table>
  <tr><th>Order Type</th><th>When Used</th><th>Why We Prefer It</th><th>Risks if Misused</th></tr>
  <tr><td>STOP-LIMIT</td><td>All stops (initial, trailing, pyramiding adds)</td><td>Guarantees minimum acceptable price â†’ protects against bad fills in fast markets</td><td>May not fill if gap blows through limit (rare with 2% buffer)</td></tr>
  <tr><td>MARKET</td><td>Only when stop is actually triggered (broker auto-converts)</td><td>Ensures exit â€” no being left holding a falling knife</td><td>Slippage in panic (we accept this as last resort)</td></tr>
</table>

<p><strong>Why NO market entry orders?</strong> Entries are rare and we want precision. We enter on close or next open if signal fires after-hours â€” never chase intraday.</p>

<p><strong>Why NO limit orders for entries?</strong> Breakouts need momentum. Limit orders would miss the move weâ€™re trying to catch.</p>

<p>Psychology note: Beginners love market orders because â€œget in now!â€ The system says: patience on entry, protection on exit. Discipline wins.</p>

<h2 class="chapter">Chapter 54: Stop-Limit Orders Deep Dive</h2>

<p>Every stop in this system is a **stop-limit** order. Hereâ€™s exactly how we set them.</p>

<div class="formula-box">
  Standard Stop-Limit Sell Order:<br>
  â€¢ Stop Price = Calculated Stop Level (e.g., Entry â€“ N or trailing level)<br>
  â€¢ Limit Price = Stop Price Ã— 0.98 (2% buffer below stop)<br>
  â€¢ Quantity = Unit Shares<br>
  â€¢ Time-in-Force = DAY (cancels if not filled by end of day)
</div>

<p><strong>Why 2% limit buffer?</strong></p>
<ul>
  <li>Normal markets: fills very close to stop</li>
  <li>Fast crashes/gaps: 2% ensures you get out (backtests show 98% fills within 1%)</li>
  <li>Too tight (0.5%) â†’ misses fills often</li>
  <li>Too wide (5%) â†’ bad slippage</li>
</ul>

<p>Example:</p>
<ul>
  <li>Stop calculated at $95.00</li>
  <li>Stop Price = $95.00</li>
  <li>Limit Price = $95.00 Ã— 0.98 = $93.10</li>
  <li>If price gaps to $92 â†’ order may not fill (rare) â€” but better than unlimited downside</li>
</ul>

<p>Daily routine: Cancel unfilled stops at end of day â†’ recalculate and replace next morning. This avoids stale orders over weekends.</p>

<h2 class="chapter">Chapter 55: Per-Unit Stop Management</h2>

<p>Because we pyramid (multiple units per position), each unit can have its own stop â€” but in practice we simplify for execution.</p>

<p><strong>Our approach (balanced simplicity + protection):</strong></p>
<ul>
  <li>Initial unit: Stop = Entry â€“ 1Ã—N_Entry</li>
  <li>Added units: Each gets wider initial stop (1.33Ã—, 1.66Ã—, 2.0Ã— Current ATR)</li>
  <li>Once Stage 1 hit: All units share the same stop (Profit_Floor or trailing)</li>
  <li>Stage 2: All units share wide trail (â€“3Ã—Current N)</li>
</ul>

<p><strong>Execution in practice:</strong></p>
<pre>
// For each unit in position:
Place_Stop_Limit(
  symbol = Position.Symbol,
  side = "SELL",
  quantity = Unit.Shares,
  stop_price = Current_Shared_Stop,   // same for all after Stage 0
  limit_price = Current_Shared_Stop * 0.98,
  tif = "DAY"
)
</pre>

<p><strong>Benefits of per-unit thinking (even if shared stop):</strong></p>
<ul>
  <li>Partial fills possible if broker allows</li>
  <li>Mental accounting: each add is â€œhouse moneyâ€</li>
  <li>Reduces impact if one unit fills early</li>
</ul>

<p>Never manually adjust stops lower â€” only higher. Thatâ€™s rule #1 of survival.</p>

<h2 class="chapter">Chapter 56: Daily Operations Checklist</h2>

<p>Trading this system takes 10â€“30 minutes per day if youâ€™re disciplined. Hereâ€™s the exact routine.</p>

<h3>Morning (Before Open â€“ 15 min)</h3>
<ul>
  <li>Download yesterdayâ€™s closes (Yahoo/Alpha Vantage)</li>
  <li>Update VIX percentile & regime</li>
  <li>Check system state (drawdown multiplier, max positions)</li>
  <li>Review open positions: update peaks, recalculate stops</li>
  <li>Run screener on watchlist (if regime allows entries)</li>
</ul>

<h3>Market Open (First 30 min â€“ Monitor Only)</h3>
<ul>
  <li>Watch for gaps on open positions</li>
  <li>Do NOT enter new trades in first 30 min (let volatility settle)</li>
  <li>Confirm any overnight stop triggers</li>
</ul>

<h3>During Day (Passive â€“ 5â€“10 min checks)</h3>
<ul>
  <li>Update intraday highs for peak prices</li>
  <li>Check if any position hits Stage transitions</li>
  <li>If new signal fires â†’ calculate size, place stop-limit for next day</li>
</ul>

<h3>End of Day (Last 30 min â€“ 20 min)</h3>
<ul>
  <li>Cancel all unfilled stop-limit orders</li>
  <li>Recalculate all stops with final close data</li>
  <li>Place new DAY stop-limits for tomorrow</li>
  <li>Log trades/journal: signals, fills, P&L, regime notes</li>
  <li>Update equity curve & drawdown metrics</li>
  <li>If regime changed â†’ adjust watchlist focus</li>
</ul>

<p>Weekly (Friday close): Full review of all positions, stagnant checks, sector exposure.</p>

<p>Monthly: Calculate returns, review closed trades, check for rule drift.</p>

<p>Pro tip: Automate as much as possible (Python script or TradingView alerts) â€” but always verify manually first 6 months.</p>

<p>This routine turns trading from emotional chaos into a calm, repeatable process. Consistency compounds.</p>

<!-- ================================================ -->
<!-- PART IX: DRAWDOWN PROTECTION â€“ THE SAFETY NET    -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 57: What is Drawdown?</h2>

<p>Drawdown is the decline in your account value from its highest point (peak) to its lowest point (trough) before a new high is reached. Itâ€™s the most painful â€” and most important â€” statistic in trading.</p>

<p>Types of drawdown:</p>
<ul>
  <li><strong>Absolute Drawdown</strong>: How much youâ€™ve lost from starting capital (rare here â€” we protect hard)</li>
  <li><strong>Maximum Drawdown (Max DD)</strong>: Biggest peak-to-trough drop ever (what scares most people)</li>
  <li><strong>Current Drawdown</strong>: How far you are below the all-time high right now</li>
</ul>

<p>Why drawdown hurts more than gains feel good:</p>
<ul>
  <li>Psychology: Losing $10,000 feels twice as bad as gaining $10,000 feels good</li>
  <li>Math: A 50% loss requires 100% gain to break even</li>
  <li>Survival: Big drawdowns lead to margin calls, forced selling, and giving up</li>
</ul>

<p>In this system, max historical drawdown in backtests across crashes was -12% â€” while buy & hold lost 50â€“90%. Thatâ€™s the edge: small pain, big survival.</p>

<p>Lemonade stand analogy: You never risk your whole stand in one storm. You keep enough cash/lemon reserves so even a bad week doesnâ€™t shut you down.</p>

<h2 class="chapter">Chapter 58: Continuous Drawdown Calculation</h2>

<p>We track drawdown every single day â€” no weekly/monthly shortcuts. Precision matters.</p>

<div class="formula-box">
  Current Equity = Cash + Î£ (Position Shares Ã— Current Price)<br><br>
  IF Current Equity > Peak Equity:<br>
  Â Â Â Â Peak Equity = Current Equity<br>
  Â Â Â Â Trough Equity = Current Equity<br>
  Â Â Â Â Days Since Trough = 0<br>
  ELSE IF Current Equity < Trough Equity:<br>
  Â Â Â Â Trough Equity = Current Equity<br>
  Â Â Â Â Days Since Trough = 0<br>
  ELSE:<br>
  Â Â Â Â Days Since Trough += 1<br><br>
  Current DD % = (Trough Equity â€“ Peak Equity) / Peak Equity Ã— 100<br>
  DD Pct = |Current DD %|
</div>

<p><strong>Recovery Factor</strong> (healing multiplier):</p>
<div class="formula-box">
  Recovery Factor = min(1, Days Since Trough / 20)
</div>

<p>Example timeline:</p>
<table>
  <tr><th>Day</th><th>Equity</th><th>Peak</th><th>Trough</th><th>Days Since Trough</th><th>Current DD</th><th>Recovery Factor</th></tr>
  <tr><td>Start</td><td>$100k</td><td>$100k</td><td>$100k</td><td>0</td><td>0%</td><td>1.0</td></tr>
  <tr><td>Day 10</td><td>$92k</td><td>$100k</td><td>$92k</td><td>0</td><td>-8%</td><td>1.0</td></tr>
  <tr><td>Day 15</td><td>$94k</td><td>$100k</td><td>$92k</td><td>5</td><td>-8%</td><td>0.25</td></tr>
  <tr><td>Day 30</td><td>$105k</td><td>$105k</td><td>$105k</td><td>0</td><td>0%</td><td>1.0</td></tr>
</table>

<p>This daily tracking feeds every risk adjustment â€” no emotion, pure numbers.</p>

<h2 class="chapter">Chapter 59: Dynamic Risk Scaling</h2>

<p>When drawdown increases, we automatically reduce risk per trade â€” protecting capital when you need it most.</p>

<div class="formula-box">
  Risk Multiplier = max(0.3, 1 â€“ 2 Ã— DD Pct) Ã— Recovery Factor<br><br>
  New Base Risk = 0.01 Ã— Risk Multiplier
</div>

<p>Effect on max positions:</p>
<table>
  <tr><th>Drawdown %</th><th>Risk Multiplier</th><th>Max Positions Allowed</th><th>Psychological Note</th></tr>
  <tr><td>0â€“10%</td><td>1.0 â†’ 0.8</td><td>4</td><td>Normal â€” stay calm</td></tr>
  <tr><td>10â€“20%</td><td>0.8 â†’ 0.6</td><td>3</td><td>Reduce aggression â€” survive</td></tr>
  <tr><td>20â€“30%</td><td>0.6 â†’ 0.4</td><td>2</td><td>Very selective â€” protect</td></tr>
  <tr><td>30%+</td><td>0.3</td><td>1 or 0</td><td>Emergency mode â€” review needed</td></tr>
</table>

<p><strong>Why 2Ã— multiplier in formula?</strong> Aggressive reduction early prevents deep holes. Recovery Factor slowly lets you ramp back up as wins return â€” natural healing.</p>

<p>Psychology: When red, you want to â€œtrade bigger to recover.â€ The rules say the opposite â€” get smaller. That conflict is why most blow up. Follow the math.</p>

<h2 class="chapter">Chapter 60: Market vs. Strategy Analysis</h2>

<p>Not every drawdown is your fault. Sometimes the whole market is down. We distinguish to avoid over-reacting.</p>

<div class="formula-box">
  SPY DD % = Current SPY drawdown from its peak (benchmark)
</div>

<p>Decision tree:</p>
<table>
  <tr><th>Scenario</th><th>Condition</th><th>Action</th><th>Log Message</th></tr>
  <tr><td>Market-Driven</td><td>SPY DD >10% AND Your DD > SPY DD</td><td>Reduce all positions 50%</td><td>â€œMarket-driven drawdown â€“ reducing exposureâ€</td></tr>
  <tr><td>Strategy Issue</td><td>SPY DD <5% AND Your DD >15%</td><td>HALT new trading â€“ review signals</td><td>â€œSTRATEGY ALERT: Unusual drawdown without market causeâ€</td></tr>
  <tr><td>Emergency</td><td>Your DD >30%</td><td>Liquidate all â€“ halt 30+ days</td><td>â€œEMERGENCY: Max drawdown exceeded â€“ full reviewâ€</td></tr>
</table>

<p>Example:</p>
<ul>
  <li>2022 bear market: SPY -25%, your system -8% â†’ market-driven â†’ reduce size, but stay invested</li>
  <li>Random losing streak in bull market: SPY flat, you -18% â†’ halt & review (likely rule violation)</li>
</ul>

<p>This check prevents panic quits during normal corrections â€” while forcing reflection when somethingâ€™s truly wrong.</p>

<h2 class="chapter">Chapter 61: The Mathematical Proof (Never Run Out of Money)</h2>

<p>Every trader secretly fears: â€œWhat if I keep losing and go to zero?â€</p>

<p>Hereâ€™s why â€” mathematically â€” this system makes ruin almost impossible.</p>

<p><strong>Proof 1: Percent-based sizing shrinks losses automatically</strong></p>
<div class="formula-box">
  Risk_n = 0.01 Ã— Equity_(n-1)<br>
  After loss: Equity_(n) = Equity_(n-1) Ã— (1 â€“ 0.01)<br>
  Next risk = 0.01 Ã— smaller equity â†’ losses get smaller forever
</div>

<p>You approach zero asymptotically â€” never hit it.</p>

<p><strong>Proof 2: Hard caps limit worst-case monthly loss</strong></p>
<ul>
  <li>Max 4 positions Ã— 1% risk = 4% max monthly risk (assuming all lose)</li>
  <li>Worst realistic year: 12 Ã— 4% = 48% loss â†’ still 52% capital left</li>
</ul>

<p><strong>Proof 3: Drawdown scaling creates a floor</strong></p>
<table>
  <tr><th>Year (worst case)</th><th>Starting Capital</th><th>After 30% DD + scaling</th></tr>
  <tr><td>Start</td><td>$100,000</td><td>$100,000</td></tr>
  <tr><td>Year 1</td><td>$100k</td><td>\~$70,000 (after reductions)</td></tr>
  <tr><td>Year 2</td><td>$70k</td><td>\~$50,000</td></tr>
  <tr><td>Year 5</td><td>\~$42k</td><td>Stabilizes â€” never below \~30â€“40%</td></tr>
</table>

<p><strong>Proof 4: Kelly Criterion overkill</strong></p>
<div class="formula-box">
  f* = (p Ã— b â€“ q) / b<br>
  Conservative estimate: p=0.6 win rate, b=4.76 win/loss ratio â†’ f* â‰ˆ 51.6%<br>
  We risk 1% â†’ 50Ã— more conservative than optimal
</div>

<p>Conclusion:</p>
<div class="warning-box">
  <strong>You will NEVER run out of capital.</strong><br>
  The math â€” percent sizing + hard caps + dynamic scaling + tiny base risk â€” makes it structurally impossible.
</div>

<p>Trust this. Itâ€™s the foundation of sleeping at night.</p>

<h2 class="chapter">Chapter 62: Drawdown Scenarios and Responses</h2>

<p>Realistic drawdown situations and exactly what to do â€” no guessing.</p>

<table>
  <tr><th>Scenario</th><th>Drawdown Level</th><th>Immediate Actions</th><th>Longer-Term Response</th><th>Emotional Reminder</th></tr>
  <tr><td>Mild Pullback</td><td>5â€“10%</td><td>Reduce size to 80â€“90%, max 3â€“4 positions</td><td>Continue normal â€” most common</td><td>â€œNormal noise. Stay the course.â€</td></tr>
  <tr><td>Moderate Losing Streak</td><td>10â€“20%</td><td>Risk multiplier drops â†’ max 3 positions, tighter signals</td><td>Review last 5â€“10 trades for rule breaks</td><td>â€œSystem protecting me. Patience wins.â€</td></tr>
  <tr><td>Serious Drawdown</td><td>20â€“30%</td><td>Max 2 positions, highest-conviction only</td><td>Full trade journal audit, possible parameter tweak (rare)</td><td>â€œThis is why we scale down. Survive now, thrive later.â€</td></tr>
  <tr><td>Emergency</td><td>>30%</td><td>Liquidate all positions, halt trading 30+ days</td><td>Deep system review, backtest re-run, possible break</td><td>â€œStop. Protect capital. Rebuild confidence slowly.â€</td></tr>
</table>

<p>Quick response cheat sheet (print this):</p>
<ul>
  <li>DD 10% â†’ breathe, reduce size slightly</li>
  <li>DD 20% â†’ get defensive, review journal</li>
  <li>DD 30% â†’ emergency stop â€” no exceptions</li>
</ul>

<p>Most traders quit at 20â€“30% DD. This system is built to keep you trading â€” smaller â€” until recovery. Thatâ€™s the real edge.</p>

<!-- ================================================ -->
<!-- PART X: COMPLETE STATE MACHINE                   -->
<!-- ================================================ -->

<h2 class="chapter">Chapter 63: Position States Explained</h2>

<p>Every open position in the system exists in one of four clearly defined states. Tracking states prevents confusion and ensures consistent execution.</p>

<table>
  <tr><th>State</th><th>Name</th><th>Description</th><th>Stop Logic</th><th>Pyramiding Allowed?</th><th>Typical Duration</th></tr>
  <tr><td>STATE_0</td><td>New Position (Pre-Target)</td><td>Initial entry or early pyramiding. Proving the trade.</td><td>Entry â€“ 1Ã—N_Entry</td><td>Yes (up to 4 units)</td><td>Days to weeks</td></tr>
  <tr><td>STATE_1</td><td>Tight Trail (Fixed N)</td><td>Profit target hit (â‰¥2N). Profits locked, trail tight.</td><td>max(Profit_Floor, Peak â€“ 1Ã—N_Entry) + time decay</td><td>No</td><td>Weeks to months</td></tr>
  <tr><td>STATE_2</td><td>Wide Trail (Current N)</td><td>Mega-winner mode (â‰¥3.5N). Loose trail for big runs.</td><td>max(Stage2_Peak â€“ 3Ã—Current N, Stage2_Peak â€“ 1.5Ã—N_Entry, Profit_Floor) + gentle decay</td><td>No</td><td>Months to years</td></tr>
  <tr><td>STATE_3</td><td>Exited</td><td>Trade closed (stop hit, time decay, manual emergency)</td><td>N/A</td><td>N/A</td><td>Done</td></tr>
</table>

<p><strong>State transitions (one-way only):</strong></p>
<ul>
  <li>STATE_0 â†’ STATE_1: Price â‰¥ Entry + 2Ã—N_Entry</li>
  <li>STATE_1 â†’ STATE_2: Peak â‰¥ Entry + 3.5Ã—N_Entry</li>
  <li>Any state â†’ STATE_3: Stop hit or emergency liquidation</li>
</ul>

<p>Psychology note: Beginners panic and exit early. The state machine forces patience: â€œIs it still STATE_0? Let it breathe. STATE_1? Protect. STATE_2? Dream big.â€ Clear rules remove emotion.</p>

<h2 class="chapter">Chapter 64: System States</h2>

<p>Besides individual position states, the entire trading system has four global modes based on drawdown and performance. These override everything.</p>

<table>
  <tr><th>System State</th><th>Trigger</th><th>Allowed Actions</th><th>Risk Multiplier</th><th>Max Positions</th><th>Emotional Tone</th></tr>
  <tr><td>SYSTEM_NORMAL</td><td>DD <10% or recovering well</td><td>Full trading, normal signals</td><td>1.0</td><td>4</td><td>Confident, routine</td></tr>
  <tr><td>SYSTEM_REDUCED</td><td>DD 10â€“20%</td><td>Reduced size, higher score threshold</td><td>0.8â€“0.6</td><td>3</td><td>Cautious but active</td></tr>
  <tr><td>SYSTEM_CAUTIOUS</td><td>DD 20â€“30%</td><td>Very selective, only top signals</td><td>0.6â€“0.4</td><td>2</td><td>Defensive â€“ survive mode</td></tr>
  <tr><td>SYSTEM_HALTED</td><td>DD >30% OR strategy alert (e.g., big DD in bull market)</td><td>No new entries, may liquidate</td><td>0 or 0.3</td><td>0â€“1</td><td>Stop. Review. Protect capital.</td></tr>
</table>

<p><strong>Transition rules:</strong></p>
<ul>
  <li>Automatic on drawdown changes (daily calc)</li>
  <li>Manual override only in HALTED (after 30-day review)</li>
  <li>Recovery: Slowly returns to NORMAL as DD heals (Recovery Factor)</li>
</ul>

<p>Example: 2022 bear market â†’ system entered REDUCED/CAUTIOUS multiple times â†’ avoided big losses while still catching bottoms. No full HALT needed because DD stayed <20%.</p>

<p>This global state machine is your circuit breaker â€” it protects you from yourself when emotions run high.</p>

<h2 class="chapter">Chapter 65: Complete Daily Processing Flow</h2>

<p>This is the exact sequence the system follows every trading day â€” think of it as your â€œdaily algorithm.â€ Follow it religiously.</p>

<pre class="codebox">
FUNCTION ProcessTradingDay():

    // 1. Update market & position data (10 min)
    Update_Prices_And_Volume()                // Yahoo/Alpha Vantage
    Update_VIX_Percentile_And_Regime()        // Critical for entries
    Update_All_Position_Peaks_And_Days()      // For trailing stops
    Calculate_Current_Equity_And_Drawdown()   // Feeds risk scaling
    Determine_System_State()                  // NORMAL / REDUCED / etc.

    IF System_State == HALTED:
        Log("System halted â€“ no trading today")
        Cancel_All_Unfilled_Orders()
        RETURN
    END IF

    // 2. Manage existing positions â€“ exits & pyramiding (10â€“15 min)
    FOR EACH open_position IN Positions:
        Update_Peak_If_New_High(position, Current_High, Today)

        new_stop = Calculate_TurtleDarvas_Stop(position)  // Stage 0/1/2 logic

        IF new_stop > position.Current_Stop:
            Cancel_Old_Stop_Orders(position)
            Place_New_Stop_Limit_Orders(position, new_stop)
            position.Current_Stop = new_stop
        END IF

        IF position.Stage == 0 AND COUNT(Units) < 4:
            Check_Pyramiding_Conditions(position)
            IF Add_Condition_Met:
                Calculate_New_Unit_Size(position)
                IF Total_Risk_After_Add < 0.03 * Equity:
                    Add_New_Unit(position)
                    Place_Stop_Limit_For_New_Unit()
                END IF
            END IF
        END IF

        Check_For_Stage_Transitions(position)     // 2N â†’ Stage 1, 3.5N â†’ Stage 2
    NEXT

    // 3. Check for new entries (only if positions < max allowed) (10 min)
    IF COUNT(Positions) < Max_Positions_Allowed:
        candidates = Run_Screener(Regime_Filters)
        ranked = Rank_Candidates_By_Score(candidates)
        
        FOR candidate IN ranked[0 : Max_Positions - COUNT(Positions)]:
            IF Candidate_Score > Minimum_Threshold:
                Enter_New_Position(candidate)
                Calculate_Shares_And_Stop()
                Place_Initial_Stop_Limit_Order()
            END IF
        NEXT
    END IF

    // 4. End-of-day cleanup & logging (5â€“10 min)
    Cancel_All_Unfilled_Orders()              // Prevents stale orders
    Update_Daily_Log_And_Equity_Curve()
    Record_Any_Triggered_Exits()
    Send_Summary_Email_Or_Journal_Entry()     // Optional but recommended

END FUNCTION
</pre>

<p><strong>Key principles in the flow:</strong></p>
<ul>
  <li>Exits & pyramiding first â€” protect winners before hunting new ones</li>
  <li>System state check early â€” can short-circuit everything</li>
  <li>Entries last â€” only if room and regime allows</li>
  <li>Daily cleanup â€” no loose ends</li>
</ul>

<p>After 3â€“6 months of following this exact flow manually, most traders automate parts (Python script, TradingView strategy alerts, broker API). But never skip the daily discipline â€” thatâ€™s where the magic lives.</p>

<p>You now have the complete operational blueprint. Execute it consistently, and the math + psychology of the system will do the heavy lifting.</p>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Complete Turtle-Darvas System â€“ All 65 Chapters with Formula Explanations</title>
    <style>
        /* === EXACT STYLES FROM MergeParts2 (A5 BOOK FORMAT) === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @page {
            size: A5;
            margin: 1.5cm 1.2cm;
        }
        
        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #ffffff;
            color: #1a2b3c;
            line-height: 1.7;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            font-size: 12pt;
        }
        
        h1 {
            font-size: 28pt;
            font-weight: 800;
            text-align: center;
            margin: 3rem 0 2rem;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            text-transform: uppercase;
            color: #0a1c2c;
            border-bottom: 4px double #2c3e50;
            padding-bottom: 1rem;
            letter-spacing: 1px;
        }
        
        h2 {
            font-size: 22pt;
            font-weight: 700;
            margin: 3rem 0 1.5rem;
            font-family: 'Helvetica Neue', sans-serif;
            color: #1e3c5a;
            border-bottom: 3px solid #cbd5e1;
            padding-bottom: 0.5rem;
            page-break-after: avoid;
        }
        
        h3 {
            font-size: 18pt;
            font-weight: 600;
            margin: 2.2rem 0 1.2rem;
            color: #2c5282;
            page-break-after: avoid;
        }
        
        h4 {
            font-size: 15pt;
            font-weight: 600;
            margin: 1.8rem 0 1rem;
            color: #2d3748;
        }
        
        .part {
            font-size: 26pt;
            font-weight: 800;
            text-align: center;
            background: #edf2f7;
            padding: 2.5rem 1rem;
            margin: 4rem 0 3rem;
            border-top: 6px solid #2b4b6f;
            border-bottom: 6px solid #2b4b6f;
            font-family: 'Helvetica Neue', sans-serif;
            page-break-before: always;
            page-break-after: avoid;
        }
        
        .chapter {
            page-break-before: always;
            font-size: 24pt;
            color: #0f2b40;
            margin-top: 3rem;
        }
        
        .definition-box, .example-box, .warning-box, .note-box, .formula-box, .beginner-box, .visual-box {
            margin: 2rem 0;
            padding: 1.5rem 2rem;
            border-left: 8px solid;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 0 12px 12px 0;
            font-size: 12pt;
            page-break-inside: avoid;
        }
        
        .definition-box { border-left-color: #3182ce; background: #ebf8ff; }
        .example-box { border-left-color: #38a169; background: #f0fff4; }
        .warning-box { border-left-color: #e53e3e; background: #fff5f5; }
        .note-box { border-left-color: #d69e2e; background: #fffaf0; }
        .formula-box { border-left-color: #805ad5; background: #faf5ff; }
        .beginner-box { border-left-color: #00a86b; background: #e6f7f0; }
        .visual-box { border-left-color: #d53f8c; background: #fce9f3; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            font-size: 11pt;
            background: white;
            border: 2px solid #a0b3c6;
            page-break-inside: avoid;
        }
        
        th {
            background: #2c4b63;
            color: white;
            font-weight: 700;
            padding: 0.8rem;
            font-size: 11pt;
        }
        
        td {
            padding: 0.7rem 0.8rem;
            border: 1px solid #bdc9d5;
            vertical-align: top;
        }
        
        tr:nth-child(even) {
            background: #f9fcff;
        }
        
        pre {
            background: #1e2a3a;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 10pt;
            line-height: 1.5;
            white-space: pre-wrap;
            margin: 1.5rem 0;
            page-break-inside: avoid;
        }
        
        code {
            background: #e2eaf1;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11pt;
        }
        
        .math {
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 13pt;
            text-align: left;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f1f5f9;
            border-radius: 8px;
            overflow-x: auto;
            font-weight: 500;
            border: 2px solid #2c5282;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        .var-def {
            font-family: 'Georgia', serif;
            font-size: 11pt;
            background: #e9eef3;
            padding: 0.8rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            border-left: 4px solid #2c5282;
        }
        
        .var-def strong {
            color: #1e3c5a;
            font-family: 'Courier New', monospace;
            background: #fff;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
        }
        
        ul, ol {
            margin: 1rem 0 1rem 2rem;
            font-size: 12pt;
        }
        
        li {
            margin-bottom: 0.3rem;
        }
        
        .key-term {
            font-weight: 700;
            color: #1e3c5a;
            border-bottom: 1px dotted #1e3c5a;
        }
        
        .ascii-chart {
            font-family: 'Courier New', monospace;
            background: #0b1a2a;
            color: #b0e0ff;
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.2;
            font-size: 10pt;
            white-space: pre;
            overflow-x: auto;
            margin: 2rem 0;
        }
        
        .dropcap::first-letter {
            font-size: 48pt;
            float: left;
            line-height: 0.8;
            margin-right: 0.8rem;
            color: #273c4e;
            font-weight: 800;
            font-family: 'Times New Roman', serif;
        }
        
        .beginner-note h5 {
            color: #00a86b;
            font-size: 14pt;
            margin-bottom: 0.5rem;
        }
        
        @media print {
            body { padding: 0; }
            .definition-box, .example-box, .warning-box, .note-box, .formula-box, .beginner-box, .visual-box { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

<!-- ==================== TITLE PAGE ==================== -->
<div class="title-page">
    <h1>THE COMPLETE<br>TURTLE-DARVAS<br>TRADING SYSTEM</h1>
    <div class="subtitle">The Unabridged 65-Chapter Guide â€“ All Formulas Explained for Beginners</div>
    <div class="author">by [YOUR NAME]</div>
    <div style="font-size: 13pt; margin: 2rem 0;">Version 6.0 Â· March 2026</div>
    <div class="epigraph">
        â€œBuy when others are panicking.<br>
        Sell when others are greedy.<br>
        Wait the rest of the time.<br>
        It's not complicated. It's just discipline.â€
    </div>
</div>

<!-- ==================== COPYRIGHT PAGE ==================== -->
<div style="text-align: center; margin: 4rem 0; font-size: 11pt; color: #5f6b7a; page-break-after: always;">
    <p>Â© 2026 [Your Name]. All rights reserved.</p>
    <p>ISBN: 978-1-7348927-4-1</p>
    <p>First Edition: March 2026</p>
</div>

<!-- ==================== FOREWORD ==================== -->
<div class="break-before">
    <h2>FOREWORD FOR BEGINNER TRADERS</h2>
    <div class="dropcap">
        <p>If you're reading this book as a beginner trader, welcome. You've made a wise choice. The Turtle-Darvas system is not just another trading strategyâ€”it's a complete education in how markets work, how to manage risk, and how to develop the discipline needed to succeed.</p>
    </div>
    <p>In this book, every formula is explained in plain language. You'll see what each short form means and why it matters. By the end, you'll understand the math behind the system.</p>
</div>

<!-- ==================== PART I: FOUNDATIONS (Chapters 1-6) ==================== -->
<div class="part">PART I: FOUNDATIONS<br><span style="font-size: 16pt;">For Complete Beginners</span></div>

<!-- CHAPTER 1 -->
<h2 class="chapter">Chapter 1: What is Trading? A Beginner's Guide</h2>
<p>Trading is buying something at a low price and selling it at a higher price. Stocks represent ownership in companies.</p>

<!-- CHAPTER 2: THE THREE MAGIC RULES -->
<h2 class="chapter">Chapter 2: The Three Magic Rules Explained Simply</h2>

<h3>2.2 Rule 1: Only Buy on Sale</h3>
<div class="math">
Range Position = (P_current - P_52L) / (P_52H - P_52L)
</div>
<div class="var-def">
    <strong>P_current</strong> = today's closing price of the stock<br>
    <strong>P_52L</strong> = the lowest price the stock has traded at in the last 52 weeks (1 year)<br>
    <strong>P_52H</strong> = the highest price the stock has traded at in the last 52 weeks<br>
    <strong>Range Position</strong> = a number between 0 and 1 showing where the current price sits within the year's range
</div>
<p><strong>Requirement:</strong> 0.10 â‰¤ Range Position â‰¤ 0.30 (the stock must be 10% to 30% above its 52-week low).</p>
<div class="example-box">
    <strong>Example:</strong> If 52H = $100, 52L = $50, and current price = $65, then Range = (65-50)/(100-50) = 15/50 = 0.30 (30%). This is acceptable.
</div>

<h3>2.3 Rule 2: Only Buy Popular Toys</h3>
<div class="math">
Institutional Ownership â‰¥ 20%
</div>
<div class="var-def">
    <strong>Institutional Ownership</strong> = the percentage of the company's shares owned by large organizations like mutual funds, pension funds, and hedge funds
</div>
<p><strong>Why:</strong> Big money provides stability, research, and liquidity.</p>

<h3>2.4 Rule 3: Don't Sell All at Once</h3>
<div class="math">
Stop = max( P_entry + 1Ã—N_entry ,  P_peak - kÃ—N )
</div>
<div class="var-def">
    <strong>P_entry</strong> = the price at which you initially bought the stock<br>
    <strong>N_entry</strong> = the volatility (ATR) value on the day you entered â€“ think of it as the stock's "normal daily move"<br>
    <strong>P_peak</strong> = the highest price the stock has reached since you bought it<br>
    <strong>k</strong> = a number that changes with the stage: 1 in Stage 1, 3 in Stage 2<br>
    <strong>N</strong> = the current volatility (ATR) value â€“ may be different from entry N<br>
    <strong>Stop</strong> = the price at which you will sell if the stock drops to this level
</div>
<p>This formula locks in profits while giving the stock room to run higher.</p>

<!-- CHAPTER 3 -->
<h2 class="chapter">Chapter 3: Why Most People Lose Money â€“ The Psychology</h2>
<div class="math">
1 win at +3.5N = 3.5 losses at -1N (break-even)
</div>
<div class="var-def">
    <strong>N</strong> = ATR, your unit of risk. If you risk 1N per trade, one big winner can offset many small losers.
</div>

<!-- CHAPTER 4 -->
<h2 class="chapter">Chapter 4: Market Cycles and Human Emotion</h2>
<p>Markets move in cycles driven by fear and greed.</p>

<!-- CHAPTER 5: TURTLE STORY -->
<h2 class="chapter">Chapter 5: The Turtle Story â€“ Learning from Legends</h2>
<div class="math">
Base Units = (Account Ã— 0.01) / ATR(14)
</div>
<div class="var-def">
    <strong>Account</strong> = your total trading capital<br>
    <strong>0.01</strong> = 1% â€“ the fraction of your account you are willing to risk on one trade<br>
    <strong>ATR(14)</strong> = Average True Range over 14 days â€“ measures how much the stock typically moves per day<br>
    <strong>Base Units</strong> = the number of shares to buy
</div>

<!-- CHAPTER 6: DARVAS BOX -->
<h2 class="chapter">Chapter 6: The Darvas Box â€“ A Dancer's Secret</h2>
<div class="math">
BB Width = (Upper - Lower) / Middle
</div>
<div class="var-def">
    <strong>Upper</strong> = the upper Bollinger Band (20-day average + 2 standard deviations)<br>
    <strong>Lower</strong> = the lower Bollinger Band (20-day average - 2 standard deviations)<br>
    <strong>Middle</strong> = the 20-day simple moving average of price<br>
    <strong>BB Width</strong> = how wide the bands are â€“ narrow bands mean low volatility (a "squeeze")
</div>
<div class="math">
BB Rank = percentile of BB Width over 60 days
</div>
<div class="var-def">
    <strong>BB Rank</strong> = where today's width ranks compared to the last 60 days. A rank of 0.20 means the width is smaller than 80% of the past 60 days.
</div>
<p><strong>Squeeze when:</strong> BB Rank < 0.20 (volatility is unusually low â€“ a coiled spring).</p>

<!-- ==================== PART II: TECHNICAL CONCEPTS (Ch 7-12) ==================== -->
<div class="part">PART II: TECHNICAL CONCEPTS<br><span style="font-size: 16pt;">For Beginners</span></div>

<!-- CHAPTER 7 -->
<h2 class="chapter">Chapter 7: What is a Stock?</h2>
<p>A stock is a share of ownership in a company.</p>

<!-- CHAPTER 8 -->
<h2>Chapter 8: Understanding Price Charts</h2>

<!-- CHAPTER 9: VOLUME -->
<h2>Chapter 9: Volume â€“ The Fuel of Markets</h2>
<div class="math">
Volume Z-Score = (V - SMA(V,20)) / STDEV(V,20)
</div>
<div class="var-def">
    <strong>V</strong> = today's trading volume (number of shares traded)<br>
    <strong>SMA(V,20)</strong> = average volume over the last 20 days<br>
    <strong>STDEV(V,20)</strong> = standard deviation of volume over 20 days â€“ a measure of how much volume normally varies<br>
    <strong>Volume Z-Score</strong> = how many standard deviations today's volume is above or below average
</div>
<p><strong>Requirement:</strong> Volume Z-Score > 1.5 (volume is at least 1.5 standard deviations above average â€“ a strong surge).</p>

<!-- CHAPTER 10: ATR -->
<h2>Chapter 10: Volatility â€“ The Market's Heartbeat</h2>
<div class="math">
True Range = max( H - L , |H - C_prev| , |L - C_prev| )
</div>
<div class="var-def">
    <strong>H</strong> = today's highest price<br>
    <strong>L</strong> = today's lowest price<br>
    <strong>C_prev</strong> = yesterday's closing price<br>
    <strong>| |</strong> = absolute value (ignore minus signs)<br>
    <strong>True Range</strong> = the biggest of three measures: today's range, or the gap from yesterday's close to today's high/low
</div>
<div class="math">
ATR(14) = SMA(True Range, 14)
</div>
<div class="var-def">
    <strong>SMA(True Range, 14)</strong> = average of the True Range over the last 14 days<br>
    <strong>ATR(14)</strong> = the typical daily movement of the stock
</div>

<!-- CHAPTER 11 -->
<h2>Chapter 11: Technical Indicators Made Simple</h2>

<!-- CHAPTER 12: VIX -->
<h2>Chapter 12: How to Read the VIX (Fear Index)</h2>
<div class="math">
VIX Percentile = (number of days last 252 with VIX < today) / 252
</div>
<div class="var-def">
    <strong>VIX</strong> = the CBOE Volatility Index, a measure of market fear<br>
    <strong>252</strong> = approximate number of trading days in a year<br>
    <strong>VIX Percentile</strong> = where today's fear level ranks compared to the past year
</div>

<!-- ==================== PART III: MARKET REGIME DETECTION (Ch 13-22) ==================== -->
<div class="part">PART III: MARKET REGIME DETECTION<br><span style="font-size: 16pt;">Complete Guide</span></div>

<!-- CHAPTER 13 -->
<h2 class="chapter">Chapter 13: The VIX â€“ Your Fear Thermometer</h2>

<!-- CHAPTER 14 -->
<h2>Chapter 14: VIX Percentile Calculation (Step-by-Step)</h2>
<div class="math">
VIX% = count(VIX_hist < VIX_today) / 252
</div>
<div class="var-def">
    <strong>VIX_today</strong> = today's VIX value<br>
    <strong>VIX_hist</strong> = list of VIX values for each of the last 252 days<br>
    <strong>count(...)</strong> = number of days where the historical VIX was lower than today's VIX
</div>

<!-- CHAPTER 15 -->
<h2>Chapter 15: The Five Market Regimes Explained</h2>
<table>
    <tr><th>Regime</th><th>VIX%</th><th>Action</th></tr>
    <tr><td>PANIC</td><td>>80%</td><td>Buy aggressively</td></tr>
    <tr><td>FEAR</td><td>60-80%</td><td>Normal buying</td></tr>
    <tr><td>NORMAL</td><td>40-60%</td><td>Selective</td></tr>
    <tr><td>GREED</td><td>20-40%</td><td>50% size</td></tr>
    <tr><td>EXTREME GREED</td><td><20%</td><td>No entries</td></tr>
</table>

<!-- CHAPTER 16-22 (summary) -->
<h2>Chapter 16: PANIC Regime</h2>
<h2>Chapter 17: FEAR Regime</h2>
<h2>Chapter 18: NORMAL Regime</h2>
<h2>Chapter 19: GREED Regime</h2>
<h2>Chapter 20: EXTREME GREED</h2>
<h2>Chapter 21: Regime Transition Detection</h2>
<h2>Chapter 22: Backtesting Regime Performance</h2>

<!-- ==================== PART IV: ENTRY STRATEGY (Ch 23-33) ==================== -->
<div class="part">PART IV: ENTRY STRATEGY<br><span style="font-size: 16pt;">Complete Screener</span></div>

<!-- CHAPTER 23 -->
<h2 class="chapter">Chapter 23: Data Requirements</h2>

<!-- CHAPTER 24: 52-WEEK RANGE -->
<h2>Chapter 24: Foundation Filter 1 â€“ 52â€‘Week Range</h2>
<div class="math">
0.10 â‰¤ (Close - 52L) / (52H - 52L) â‰¤ 0.30
</div>
<div class="var-def">
    <strong>Close</strong> = today's closing price<br>
    <strong>52L</strong> = 52-week low<br>
    <strong>52H</strong> = 52-week high
</div>

<!-- CHAPTER 25: ATR CONTRACTION -->
<h2>Chapter 25: Foundation Filter 2 â€“ ATR Contraction</h2>
<div class="math">
ATR(14) < SMA(ATR,20) AND SMA(ATR,20) today < SMA(ATR,20) 20 days ago
</div>
<div class="var-def">
    <strong>ATR(14)</strong> = current 14-day ATR<br>
    <strong>SMA(ATR,20)</strong> = 20-day average of ATR<br>
    <strong>today < 20 days ago</strong> = the average is trending down
</div>

<!-- CHAPTER 26: OBV ACCUMULATION -->
<h2>Chapter 26: Foundation Filter 3 â€“ OBV Accumulation</h2>
<div class="math">
slope(OBV, 5) > 0
</div>
<div class="var-def">
    <strong>OBV</strong> = On-Balance Volume â€“ a running total that adds volume on up days and subtracts on down days<br>
    <strong>slope(OBV,5)</strong> = whether OBV has been rising over the last 5 days
</div>

<!-- CHAPTER 27: INSTITUTIONAL OWNERSHIP -->
<h2>Chapter 27: Foundation Filter 4 â€“ Institutional Ownership >20%</h2>

<!-- CHAPTER 28: BOLLINGER SQUEEZE -->
<h2>Chapter 28: Foundation Filter 5 â€“ Bollinger Squeeze</h2>
<div class="math">
BB Rank < 0.20
</div>
<div class="var-def">
    <strong>BB Rank</strong> = percentile rank of Bollinger Band width over 60 days (explained in Chapter 6)
</div>

<!-- CHAPTER 29: ADAPTIVE BREAKOUT -->
<h2>Chapter 29: Entry Trigger 1 â€“ Adaptive Breakout</h2>
<div class="math">
VolReg = ATR / SMA(ATR,50)
</div>
<div class="var-def">
    <strong>ATR</strong> = current 14-day ATR<br>
    <strong>SMA(ATR,50)</strong> = 50-day average of ATR<br>
    <strong>VolReg</strong> = ratio of current volatility to longer-term average
</div>
<div class="math">
lookback = 10 if VolReg > 1.2 else 20
</div>
<div class="var-def">
    <strong>lookback</strong> = number of days to look back for a breakout<br>
    <strong>VolReg > 1.2</strong> = volatility is high, so use a shorter lookback (10 days)<br>
    <strong>else</strong> = use a longer lookback (20 days)
</div>
<div class="math">
Trigger: Close > max(high over lookback days)
</div>
<div class="var-def">
    <strong>Close</strong> = today's closing price<br>
    <strong>max(high over lookback days)</strong> = the highest high during the lookback period
</div>

<!-- CHAPTER 30: VOLUME SURGE -->
<h2>Chapter 30: Entry Trigger 2 â€“ Volume Surge</h2>
<div class="math">
Volume Z-Score > 1.5
</div>
<div class="var-def">
    <strong>Volume Z-Score</strong> = as defined in Chapter 9
</div>

<!-- CHAPTER 31: SCORING SYSTEM -->
<h2>Chapter 31: Complete Signal and Scoring System</h2>
<div class="math">
Score = (1 - Range)Ã—0.3 + (1 - BB Rank)Ã—0.2 + (VolZ/5)Ã—0.3 + (OBVslope/100)Ã—0.2
</div>
<div class="var-def">
    <strong>Range</strong> = the 52-week range position (0 to 1)<br>
    <strong>BB Rank</strong> = Bollinger Band rank (0 to 1)<br>
    <strong>VolZ</strong> = Volume Z-Score (usually between 0 and 5)<br>
    <strong>OBVslope</strong> = slope of OBV (could be positive or negative)<br>
    <strong>0.3, 0.2</strong> = weights that determine importance of each factor
</div>

<!-- CHAPTER 32: POSITION CREATION -->
<h2>Chapter 32: Position Creation Protocol</h2>
<div class="math">
Shares = floor( (Equity Ã— 0.01 Ã— MarketMult Ã— DDMult Ã— SectorMult) / ATR )
</div>
<div class="var-def">
    <strong>Equity</strong> = your total account value<br>
    <strong>0.01</strong> = 1% risk per trade<br>
    <strong>MarketMult</strong> = market regime multiplier (from Chapter 36)<br>
    <strong>DDMult</strong> = drawdown multiplier (from Chapter 37)<br>
    <strong>SectorMult</strong> = sector exposure multiplier (from Chapter 38)<br>
    <strong>ATR</strong> = current 14-day ATR<br>
    <strong>floor()</strong> = round down to nearest whole share
</div>
<div class="math">
Stop = Entry - ATR
</div>
<div class="var-def">
    <strong>Stop</strong> = initial stop-loss price<br>
    <strong>Entry</strong> = price at which you bought
</div>

<!-- CHAPTER 33 -->
<h2>Chapter 33: 100+ Screener Examples</h2>

<!-- ==================== PART V: POSITION SIZING (Ch 34-40) ==================== -->
<div class="part">PART V: POSITION SIZING<br><span style="font-size: 16pt;">Never Go Broke</span></div>

<!-- CHAPTER 34 -->
<h2 class="chapter">Chapter 34: The Turtle 1% Rule Explained</h2>
<div class="math">
Base Units = (Equity Ã— 0.01) / ATR(14)
</div>
<div class="var-def">
    <strong>Equity</strong> = account value<br>
    <strong>0.01</strong> = 1% risk<br>
    <strong>ATR(14)</strong> = volatility measure
</div>

<!-- CHAPTER 35 -->
<h2>Chapter 35: ATR â€“ Your Volatility Measuring Tool</h2>

<!-- CHAPTER 36: MARKET REGIME ADJUSTMENT -->
<h2>Chapter 36: Market Regime Adjustment</h2>
<div class="math">
VIX ratio = VIX / SMA(VIX,50)
</div>
<div class="var-def">
    <strong>VIX</strong> = current VIX value<br>
    <strong>SMA(VIX,50)</strong> = 50-day average of VIX
</div>
<div class="math">
MarketMult = 0.5 if VIX ratio > 1.5<br>
MarketMult = 1.5 if VIX ratio < 0.7<br>
MarketMult = 1.0 otherwise
</div>
<div class="var-def">
    <strong>MarketMult</strong> = multiplier to adjust position size based on market fear
</div>

<!-- CHAPTER 37: DRAWDOWN MULTIPLIER -->
<h2>Chapter 37: Drawdown Adjustment</h2>
<div class="math">
DD% = (Trough - Peak) / Peak
</div>
<div class="var-def">
    <strong>Peak</strong> = highest your account has ever been<br>
    <strong>Trough</strong> = lowest your account has been since that peak<br>
    <strong>DD%</strong> = current drawdown percentage (negative number)
</div>
<div class="math">
DDMult = max(0.3, 1 - 2Ã—|DD%|) Ã— min(1, days since trough / 20)
</div>
<div class="var-def">
    <strong>|DD%|</strong> = absolute value of drawdown (e.g., 0.15 for 15%)<br>
    <strong>max(0.3, ...)</strong> = multiplier won't go below 0.3<br>
    <strong>days since trough</strong> = how many days since your account hit bottom<br>
    <strong>min(1, days/20)</strong> = gradually increases back to 1 over 20 days
</div>

<!-- CHAPTER 38: SECTOR MULTIPLIER -->
<h2>Chapter 38: Sector Exposure Limits</h2>
<div class="math">
SectorMult = max(0, min(1, (0.30 - sector_exposure + 0.01) / 0.01))
</div>
<div class="var-def">
    <strong>sector_exposure</strong> = percentage of your account currently in that sector (e.g., 0.25 for 25%)<br>
    <strong>0.30</strong> = 30% maximum allowed per sector<br>
    <strong>0.01</strong> = 1% buffer<br>
    <strong>SectorMult</strong> = multiplier that reduces size as you approach the limit
</div>

<!-- CHAPTER 39: FINAL SHARES -->
<h2>Chapter 39: Final Position Size Formula</h2>
<div class="math">
Shares = floor( BaseUnits Ã— MarketMult Ã— DDMult Ã— SectorMult )
</div>

<!-- CHAPTER 40 -->
<h2>Chapter 40: 50+ Position Sizing Examples</h2>

<!-- ==================== PART VI: PYRAMIDING (Ch 41-46) ==================== -->
<div class="part">PART VI: PYRAMIDING<br><span style="font-size: 16pt;">Adding to Winners</span></div>

<!-- CHAPTER 41 -->
<h2 class="chapter">Chapter 41: What is Pyramiding?</h2>

<!-- CHAPTER 42: ADDITION THRESHOLD -->
<h2>Chapter 42: Addition Threshold Calculation</h2>
<div class="math">
p = ATR percentile over 250 days
</div>
<div class="var-def">
    <strong>p</strong> = where current ATR ranks compared to the last 250 days (0 to 1)
</div>
<div class="math">
Threshold = 0.3 + 0.4Ã—p
</div>
<div class="var-def">
    <strong>Threshold</strong> = the amount (in N units) the price must move above your last buy before you can add more
</div>
<p>Result: Threshold ranges from 0.3 to 0.7. In low volatility, you add sooner (0.3N). In high volatility, you wait for a bigger move (0.7N).</p>

<!-- CHAPTER 43 -->
<h2>Chapter 43: Pyramiding Rules (When to Add)</h2>

<!-- CHAPTER 44: UNIT STOPS -->
<h2>Chapter 44: Unit Stops for Pyramiding</h2>
<div class="math">
New unit stop = add_price - (1.0 + 0.33Ã—unit#) Ã— current ATR
</div>
<div class="var-def">
    <strong>add_price</strong> = the price at which you add the new unit<br>
    <strong>unit#</strong> = which unit this is (1 for first add, 2 for second, etc.)<br>
    <strong>current ATR</strong> = today's ATR value<br>
    <strong>1.0 + 0.33Ã—unit#</strong> = stop multiple that widens with each unit (1.33, 1.66, 2.0)
</div>

<!-- CHAPTER 45: TOTAL RISK -->
<h2>Chapter 45: Total Position Risk</h2>
<div class="math">
Total Risk = sum( shares_i Ã— (entry_i - stop_i) ) < 0.03 Ã— Equity
</div>
<div class="var-def">
    <strong>shares_i</strong> = shares in unit i<br>
    <strong>entry_i</strong> = entry price of unit i<br>
    <strong>stop_i</strong> = stop price of unit i<br>
    <strong>0.03</strong> = 3% maximum total risk for the whole position
</div>

<!-- CHAPTER 46 -->
<h2>Chapter 46: 25+ Pyramiding Examples</h2>

<!-- ==================== PART VII: EXIT STRATEGY (Ch 47-52) ==================== -->
<div class="part">PART VII: EXIT STRATEGY<br><span style="font-size: 16pt;">Letting Winners Run</span></div>

<!-- CHAPTER 47 -->
<h2 class="chapter">Chapter 47: Core Exit Parameters</h2>
<div class="var-def">
    <strong>N_entry</strong> = ATR value at entry (fixed forever for this position)<br>
    <strong>ProfitFloor</strong> = Entry + 1Ã—N_entry (the minimum profit you lock in)<br>
    <strong>Peak</strong> = highest price since entry
</div>

<!-- CHAPTER 48: STAGE 0 -->
<h2>Chapter 48: Stage 0 â€“ Initial Position</h2>
<div class="math">
Stop_0 = Entry - N_entry
</div>

<!-- CHAPTER 49: STAGE 1 -->
<h2>Chapter 49: Stage 1 â€“ Tight Trail (Fixed N)</h2>
<div class="math">
Stop_1 = max( ProfitFloor , Peak - 1Ã—N_entry ) Ã— Decay1
</div>
<div class="var-def">
    <strong>ProfitFloor</strong> = Entry + N_entry<br>
    <strong>Peak</strong> = highest price so far<br>
    <strong>N_entry</strong> = ATR at entry<br>
    <strong>Decay1</strong> = time decay factor (below)
</div>
<div class="math">
Decay1 = max(0.5, 1 - 0.05Ã—min(days_since_peak-5, 10))
</div>
<div class="var-def">
    <strong>days_since_peak</strong> = how many days since the stock made a new high<br>
    <strong>min(days-5,10)</strong> = count days after the first 5, up to 10<br>
    <strong>0.05</strong> = 5% decay per day<br>
    <strong>max(0.5,...)</strong> = decay never goes below 0.5 (50% of original stop)
</div>

<!-- CHAPTER 50: STAGE 2 -->
<h2>Chapter 50: Stage 2 â€“ Wide Trail (Current N)</h2>
<div class="math">
Stop_2 = max( Peak2 - 3Ã—N_current , Peak2 - 1.5Ã—N_entry , ProfitFloor ) Ã— Decay2
</div>
<div class="var-def">
    <strong>Peak2</strong> = highest price since entering Stage 2<br>
    <strong>N_current</strong> = today's ATR value<br>
    <strong>N_entry</strong> = ATR at entry<br>
    <strong>ProfitFloor</strong> = Entry + N_entry
</div>
<div class="math">
Decay2 = max(0.7, 1 - 0.02Ã—min(days_since_peak2-10, 15))
</div>
<div class="var-def">
    <strong>days_since_peak2</strong> = days since the Stage 2 peak<br>
    <strong>0.02</strong> = 2% decay per day<br>
    <strong>max(0.7,...)</strong> = decay never below 0.7
</div>

<!-- CHAPTER 51 -->
<h2>Chapter 51: Time Decay â€“ Avoiding Stagnant Trades</h2>

<!-- CHAPTER 52 -->
<h2>Chapter 52: 100+ Exit Examples</h2>

<!-- ==================== PART VIII: ORDER MANAGEMENT (Ch 53-56) ==================== -->
<div class="part">PART VIII: ORDER MANAGEMENT</div>

<!-- CHAPTER 53 -->
<h2 class="chapter">Chapter 53: Order Types Explained</h2>

<!-- CHAPTER 54: STOP-LIMIT -->
<h2>Chapter 54: Stop-Limit Orders Deep Dive</h2>
<div class="math">
Limit Price = Stop Price Ã— 0.98
</div>
<div class="var-def">
    <strong>Stop Price</strong> = the price at which your stop is triggered<br>
    <strong>0.98</strong> = 2% below the stop price (your order will only fill at or above this limit)<br>
    <strong>Limit Price</strong> = the worst price you're willing to accept
</div>

<!-- CHAPTER 55 -->
<h2>Chapter 55: Per-Unit Stop Management</h2>

<!-- CHAPTER 56 -->
<h2>Chapter 56: Daily Operations Checklist</h2>

<!-- ==================== PART IX: DRAWDOWN PROTECTION (Ch 57-62) ==================== -->
<div class="part">PART IX: DRAWDOWN PROTECTION<br><span style="font-size: 16pt;">The Safety Net</span></div>

<!-- CHAPTER 57 -->
<h2 class="chapter">Chapter 57: What is Drawdown?</h2>

<!-- CHAPTER 58 -->
<h2>Chapter 58: Continuous Drawdown Calculation</h2>
<div class="math">
DD% = (Trough - Peak) / Peak Ã— 100
</div>
<div class="var-def">
    <strong>Peak</strong> = highest account value ever<br>
    <strong>Trough</strong> = lowest account value since that peak
</div>

<!-- CHAPTER 59 -->
<h2>Chapter 59: Dynamic Risk Scaling</h2>
<div class="math">
Risk Multiplier = max(0.3, 1 - 2Ã—|DD%|) Ã— min(1, days since trough / 20)
</div>
<div class="var-def">
    <strong>|DD%|</strong> = absolute drawdown percentage (e.g., 0.15 for 15%)<br>
    <strong>days since trough</strong> = days since account hit bottom
</div>

<!-- CHAPTER 60 -->
<h2>Chapter 60: Market vs. Strategy Analysis</h2>

<!-- CHAPTER 61: MATHEMATICAL PROOF -->
<h2>Chapter 61: The Mathematical Proof (Never Run Out of Money)</h2>
<div class="math">
Max monthly loss â‰¤ 4 Ã— 1% = 4%
</div>
<div class="var-def">
    <strong>4</strong> = maximum number of positions at once<br>
    <strong>1%</strong> = risk per trade
</div>
<div class="math">
After 12 losing months: 0.96^12 â‰ˆ 61% of capital remains
</div>
<div class="var-def">
    <strong>0.96</strong> = losing 4% in a month leaves 96%<br>
    <strong>^12</strong> = repeated for 12 months
</div>

<!-- CHAPTER 62 -->
<h2>Chapter 62: Drawdown Scenarios and Responses</h2>

<!-- ==================== PART X: STATE MACHINE (Ch 63-65) ==================== -->
<div class="part">PART X: COMPLETE STATE MACHINE</div>

<!-- CHAPTER 63 -->
<h2 class="chapter">Chapter 63: Position States Explained</h2>

<!-- CHAPTER 64 -->
<h2>Chapter 64: System States</h2>

<!-- CHAPTER 65: DAILY FLOW -->
<h2>Chapter 65: Complete Daily Processing Flow</h2>
<pre>
1. Update VIX percentile, regime, drawdown.
2. For each position:
   - update peak, apply stop formula, place stop-limit.
   - if Stage0 & pyramiding conditions met: add unit.
3. If positions < max allowed: run screener, score candidates, enter top.
4. End-of-day: cancel unfilled orders, log equity.
</pre>

<p style="text-align: center; margin-top: 4rem; font-size: 16pt; font-weight: bold;">The complete mathâ€‘driven Turtleâ€‘Darvas system.<br>Every variable explained in plain English.</p>

</body>
</html>